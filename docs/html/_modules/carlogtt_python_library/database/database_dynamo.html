<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>carlogtt_python_library.database.database_dynamo &#8212; CarlogttPythonLibrary r. documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="../../../_static/basic.css?v=9d6d948b" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css?v=772fa434" />
    <script src="../../../_static/documentation_options.js?v=30015795"></script>
    <script src="../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for carlogtt_python_library.database.database_dynamo</h1><div class="highlight"><pre>
<span></span><span class="c1"># ======================================================================</span>
<span class="c1"># MODULE DETAILS</span>
<span class="c1"># This section provides metadata about the module, including its</span>
<span class="c1"># creation date, author, copyright information, and a brief description</span>
<span class="c1"># of the module&#39;s purpose and functionality.</span>
<span class="c1"># ======================================================================</span>

<span class="c1">#   __|    \    _ \  |      _ \   __| __ __| __ __|</span>
<span class="c1">#  (      _ \     /  |     (   | (_ |    |      |</span>
<span class="c1"># \___| _/  _\ _|_\ ____| \___/ \___|   _|     _|</span>

<span class="c1"># src/carlogtt_library/database/database_dynamo.py</span>
<span class="c1"># Created 9/30/23 - 4:38 PM UK Time (London) by carlogtt</span>
<span class="c1"># Copyright (c) Amazon.com Inc. All Rights Reserved.</span>
<span class="c1"># AMAZON.COM CONFIDENTIAL</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module ...</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># ======================================================================</span>
<span class="c1"># EXCEPTIONS</span>
<span class="c1"># This section documents any exceptions made or code quality rules.</span>
<span class="c1"># These exceptions may be necessary due to specific coding requirements</span>
<span class="c1"># or to bypass false positives.</span>
<span class="c1"># ======================================================================</span>
<span class="c1">#</span>

<span class="c1"># ======================================================================</span>
<span class="c1"># IMPORTS</span>
<span class="c1"># Importing required libraries and modules for the application.</span>
<span class="c1"># ======================================================================</span>

<span class="c1"># Standard Library Imports</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">decimal</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numbers</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections.abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">Generator</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">,</span> <span class="n">MutableMapping</span><span class="p">,</span> <span class="n">Sequence</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">TypedDict</span><span class="p">,</span> <span class="n">Union</span>

<span class="c1"># Third Party Library Imports</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">botocore.config</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">botocore.exceptions</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">mypy_boto3_dynamodb</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mypy_boto3_dynamodb</span><span class="w"> </span><span class="kn">import</span> <span class="n">type_defs</span>

<span class="c1"># Local Folder (Relative) Imports</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..</span><span class="w"> </span><span class="kn">import</span> <span class="n">aws_boto3</span><span class="p">,</span> <span class="n">exceptions</span><span class="p">,</span> <span class="n">utils</span>

<span class="c1"># END IMPORTS</span>
<span class="c1"># ======================================================================</span>


<span class="c1"># List of public names in the module</span>
<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;DynamoDB&#39;</span><span class="p">,</span>
<span class="p">]</span>

<span class="c1"># Setting up logger for current module</span>
<span class="n">module_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># Type aliases</span>
<span class="n">DynamoDBClient</span> <span class="o">=</span> <span class="n">mypy_boto3_dynamodb</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">DynamoDBClient</span>

<span class="c1"># Placeholder, replace Any with AttributeValue later</span>
<span class="n">DynamoDbList</span> <span class="o">=</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
<span class="n">DynamoDbListDeserialized</span> <span class="o">=</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
<span class="n">DynamoDbMap</span> <span class="o">=</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
<span class="n">DynamoDbMapDeserialized</span> <span class="o">=</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>

<span class="n">PartitionKeyValue</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>

<span class="n">AttributeValue</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span>
    <span class="nb">str</span><span class="p">,</span>
    <span class="nb">bytes</span><span class="p">,</span>
    <span class="nb">bytearray</span><span class="p">,</span>
    <span class="nb">int</span><span class="p">,</span>
    <span class="nb">float</span><span class="p">,</span>
    <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">,</span>
    <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="nb">set</span><span class="p">[</span><span class="nb">bytes</span><span class="p">],</span>
    <span class="nb">set</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
    <span class="nb">set</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
    <span class="nb">set</span><span class="p">[</span><span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">],</span>
    <span class="n">DynamoDbList</span><span class="p">,</span>
    <span class="n">DynamoDbMap</span><span class="p">,</span>
    <span class="nb">bool</span><span class="p">,</span>
    <span class="kc">None</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">AttributeValueDeserialized</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span>
    <span class="nb">str</span><span class="p">,</span>
    <span class="nb">bytes</span><span class="p">,</span>
    <span class="nb">bytearray</span><span class="p">,</span>
    <span class="nb">int</span><span class="p">,</span>
    <span class="nb">float</span><span class="p">,</span>
    <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="nb">set</span><span class="p">[</span><span class="nb">bytes</span><span class="p">],</span>
    <span class="nb">set</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
    <span class="nb">set</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
    <span class="n">DynamoDbListDeserialized</span><span class="p">,</span>
    <span class="n">DynamoDbMapDeserialized</span><span class="p">,</span>
    <span class="nb">bool</span><span class="p">,</span>
    <span class="kc">None</span><span class="p">,</span>
<span class="p">]</span>

<span class="c1"># Now replace the placeholders with actual definition</span>
<span class="n">DynamoDbList</span> <span class="o">=</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">AttributeValue</span><span class="p">]</span>  <span class="c1"># type: ignore</span>
<span class="n">DynamoDbListDeserialized</span> <span class="o">=</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">AttributeValueDeserialized</span><span class="p">]</span>  <span class="c1"># type: ignore</span>
<span class="n">DynamoDbMap</span> <span class="o">=</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">AttributeValue</span><span class="p">]</span>  <span class="c1"># type: ignore</span>
<span class="n">DynamoDbMapDeserialized</span> <span class="o">=</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">AttributeValueDeserialized</span><span class="p">]</span>  <span class="c1"># type: ignore</span>

<span class="c1"># General DynamoDB type annotations</span>
<span class="n">PartitionKeyTypeDef</span> <span class="o">=</span> <span class="n">TypedDict</span><span class="p">(</span>
    <span class="s2">&quot;PartitionKeyTypeDef&quot;</span><span class="p">,</span>
    <span class="p">{</span>
        <span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">PartitionKeyItem</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">PartitionKeyTypeDef</span><span class="p">]</span>
<span class="n">Item</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">type_defs</span><span class="o">.</span><span class="n">AttributeValueTypeDef</span><span class="p">]</span>


<div class="viewcode-block" id="DynamoDB">
<a class="viewcode-back" href="../../../_apidoc/carlogtt_python_library.database.database_dynamo.html#carlogtt_python_library.database.database_dynamo.DynamoDB">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DynamoDB</span><span class="p">(</span><span class="n">aws_boto3</span><span class="o">.</span><span class="n">aws_service_base</span><span class="o">.</span><span class="n">AwsServiceBase</span><span class="p">[</span><span class="n">DynamoDBClient</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The DynamoDB class provides a simplified interface for interacting</span>
<span class="sd">    with Amazon DynamoDB services within a Python application.</span>

<span class="sd">    It includes an option to cache the client session to minimize</span>
<span class="sd">    the number of AWS API call.</span>

<span class="sd">    :param aws_region_name: The name of the AWS region where the</span>
<span class="sd">           service is to be used. This parameter is required to</span>
<span class="sd">           configure the AWS client.</span>
<span class="sd">    :param aws_profile_name: The name of the AWS profile to use for</span>
<span class="sd">           credentials. This is useful if you have multiple profiles</span>
<span class="sd">           configured in your AWS credentials file.</span>
<span class="sd">           Default is None, which means the default profile or</span>
<span class="sd">           environment variables will be used if not provided.</span>
<span class="sd">    :param aws_access_key_id: The AWS access key ID for</span>
<span class="sd">           programmatically accessing AWS services. This parameter</span>
<span class="sd">           is optional and only needed if not using a profile from</span>
<span class="sd">           the AWS credentials file.</span>
<span class="sd">    :param aws_secret_access_key: The AWS secret access key</span>
<span class="sd">           corresponding to the provided access key ID. Like the</span>
<span class="sd">           access key ID, this parameter is optional and only needed</span>
<span class="sd">           if not using a profile.</span>
<span class="sd">    :param aws_session_token: The AWS temporary session token</span>
<span class="sd">           corresponding to the provided access key ID. Like the</span>
<span class="sd">           access key ID, this parameter is optional and only needed</span>
<span class="sd">           if not using a profile.</span>
<span class="sd">    :param caching: Determines whether to enable caching for the</span>
<span class="sd">           client session. If set to True, the client session will</span>
<span class="sd">           be cached to improve performance and reduce the number</span>
<span class="sd">           of API calls. Default is False.</span>
<span class="sd">    :param client_parameters: A key-value pair object of parameters that</span>
<span class="sd">           will be passed to the low-level service client.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">aws_region_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">aws_profile_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">aws_access_key_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">aws_secret_access_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">aws_session_token</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">caching</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">client_parameters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">aws_region_name</span><span class="o">=</span><span class="n">aws_region_name</span><span class="p">,</span>
            <span class="n">aws_profile_name</span><span class="o">=</span><span class="n">aws_profile_name</span><span class="p">,</span>
            <span class="n">aws_access_key_id</span><span class="o">=</span><span class="n">aws_access_key_id</span><span class="p">,</span>
            <span class="n">aws_secret_access_key</span><span class="o">=</span><span class="n">aws_secret_access_key</span><span class="p">,</span>
            <span class="n">aws_session_token</span><span class="o">=</span><span class="n">aws_session_token</span><span class="p">,</span>
            <span class="n">caching</span><span class="o">=</span><span class="n">caching</span><span class="p">,</span>
            <span class="n">client_parameters</span><span class="o">=</span><span class="n">client_parameters</span><span class="p">,</span>
            <span class="n">aws_service_name</span><span class="o">=</span><span class="s2">&quot;dynamodb&quot;</span><span class="p">,</span>
            <span class="n">exception_type</span><span class="o">=</span><span class="n">exceptions</span><span class="o">.</span><span class="n">DynamoDBError</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_serializer</span> <span class="o">=</span> <span class="n">DynamoDbSerializer</span><span class="p">()</span>

<div class="viewcode-block" id="DynamoDB.get_tables">
<a class="viewcode-back" href="../../../_apidoc/carlogtt_python_library.database.database_dynamo.html#carlogtt_python_library.database.database_dynamo.DynamoDB.get_tables">[docs]</a>
    <span class="nd">@utils</span><span class="o">.</span><span class="n">retry</span><span class="p">(</span><span class="n">exception_to_check</span><span class="o">=</span><span class="n">exceptions</span><span class="o">.</span><span class="n">DynamoDBError</span><span class="p">,</span> <span class="n">delay_secs</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns an array of table names associated with the current</span>
<span class="sd">        account and endpoint.</span>

<span class="sd">        :return: List of table names.</span>
<span class="sd">        :raise DynamoDBError: If listing fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">dynamodb_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">list_tables</span><span class="p">()</span>

        <span class="k">except</span> <span class="n">botocore</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">DynamoDBError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="o">.</span><span class="n">response</span><span class="p">))</span> <span class="kn">from</span><span class="w"> </span><span class="kc">None</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">DynamoDBError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span> <span class="kn">from</span><span class="w"> </span><span class="kc">None</span>

        <span class="c1"># If TableNames is not present then return an empty list</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">dynamodb_response</span><span class="p">[</span><span class="s1">&#39;TableNames&#39;</span><span class="p">]</span>

        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">return</span> <span class="n">response</span></div>


<div class="viewcode-block" id="DynamoDB.get_items">
<a class="viewcode-back" href="../../../_apidoc/carlogtt_python_library.database.database_dynamo.html#carlogtt_python_library.database.database_dynamo.DynamoDB.get_items">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_items</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">AttributeValueDeserialized</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns an Iterable of deserialized items in the table.</span>

<span class="sd">        :param table: DynamoDB table name.</span>
<span class="sd">        :return: Generator of deserialized items.</span>
<span class="sd">            Iterable of dictionaries of all the columns in DynamoDB</span>
<span class="sd">            i.e. {dynamodb_column_name: column_value, ...}</span>
<span class="sd">        :raise DynamoDBError: If retrieval fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">dynamodb_scan_args</span><span class="p">:</span> <span class="n">type_defs</span><span class="o">.</span><span class="n">ScanInputTypeDef</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;TableName&#39;</span><span class="p">:</span> <span class="n">table</span><span class="p">}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">utils</span><span class="o">.</span><span class="n">retry</span><span class="p">(</span><span class="n">exception_to_check</span><span class="o">=</span><span class="ne">Exception</span><span class="p">,</span> <span class="n">delay_secs</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">as</span> <span class="n">retryer</span><span class="p">:</span>
                        <span class="n">dynamodb_response</span> <span class="o">=</span> <span class="n">retryer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">scan</span><span class="p">,</span> <span class="o">**</span><span class="n">dynamodb_scan_args</span><span class="p">)</span>

                <span class="k">except</span> <span class="n">botocore</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">DynamoDBError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="o">.</span><span class="n">response</span><span class="p">))</span>

                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">DynamoDBError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">dynamodb_response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Items&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">dynamodb_response</span><span class="p">[</span><span class="s1">&#39;Items&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># Convert the DynamoDB attribute values to</span>
                    <span class="c1"># deserialized values</span>
                    <span class="n">deserialized_items</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="p">{</span>
                            <span class="n">key</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializer</span><span class="o">.</span><span class="n">deserialize_att</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">dynamodb_item</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                        <span class="p">}</span>
                        <span class="k">for</span> <span class="n">dynamodb_item</span> <span class="ow">in</span> <span class="n">dynamodb_response</span><span class="p">[</span><span class="s1">&#39;Items&#39;</span><span class="p">]</span>
                    <span class="p">)</span>

                    <span class="k">yield from</span> <span class="n">deserialized_items</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Nothing to yield</span>
                    <span class="k">yield from</span> <span class="p">()</span>

                <span class="c1"># If LastEvaluatedKey is present then we need to scan</span>
                <span class="c1"># for more items</span>
                <span class="k">if</span> <span class="n">dynamodb_response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;LastEvaluatedKey&#39;</span><span class="p">):</span>
                    <span class="n">dynamodb_scan_args</span><span class="p">[</span><span class="s1">&#39;ExclusiveStartKey&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dynamodb_response</span><span class="p">[</span><span class="s1">&#39;LastEvaluatedKey&#39;</span><span class="p">]</span>

                <span class="c1"># If no LastEvaluatedKey then break out of the while</span>
                <span class="c1"># loop as we&#39;re done</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">break</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">DynamoDBError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span> <span class="kn">from</span><span class="w"> </span><span class="kc">None</span></div>


<div class="viewcode-block" id="DynamoDB.get_items_count">
<a class="viewcode-back" href="../../../_apidoc/carlogtt_python_library.database.database_dynamo.html#carlogtt_python_library.database.database_dynamo.DynamoDB.get_items_count">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_items_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the number of items in a table.</span>

<span class="sd">        :param table: DynamoDB table name.</span>
<span class="sd">        :return: Item count.</span>
<span class="sd">        :raise DynamoDBError: If count fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">running_total</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_items</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
            <span class="n">running_total</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">running_total</span></div>


<div class="viewcode-block" id="DynamoDB.get_item">
<a class="viewcode-back" href="../../../_apidoc/carlogtt_python_library.database.database_dynamo.html#carlogtt_python_library.database.database_dynamo.DynamoDB.get_item">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_item</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">partition_key_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">partition_key_value</span><span class="p">:</span> <span class="n">PartitionKeyValue</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">AttributeValueDeserialized</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The get_item_from_table operation returns a dictionary of</span>
<span class="sd">        deserialized attribute values for the item with the given</span>
<span class="sd">        primary key. If there is no matching item, get_item_from_table</span>
<span class="sd">        returns None.</span>

<span class="sd">        :param table: DynamoDB table name.</span>
<span class="sd">        :param partition_key_key: The key of the partition key.</span>
<span class="sd">        :param partition_key_value: The value of the partition key.:</span>
<span class="sd">        :return: Deserialized item or None.</span>
<span class="sd">        :raise DynamoDBError: If retrieval fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">partition_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializer</span><span class="o">.</span><span class="n">serialize_p_key</span><span class="p">(</span><span class="n">partition_key_key</span><span class="p">,</span> <span class="n">partition_key_value</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">utils</span><span class="o">.</span><span class="n">retry</span><span class="p">(</span><span class="n">exception_to_check</span><span class="o">=</span><span class="ne">Exception</span><span class="p">,</span> <span class="n">delay_secs</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">as</span> <span class="n">retryer</span><span class="p">:</span>
                <span class="n">dynamodb_response</span> <span class="o">=</span> <span class="n">retryer</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">get_item</span><span class="p">,</span> <span class="n">TableName</span><span class="o">=</span><span class="n">table</span><span class="p">,</span> <span class="n">Key</span><span class="o">=</span><span class="n">partition_key</span>
                <span class="p">)</span>

        <span class="k">except</span> <span class="n">botocore</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">DynamoDBError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="o">.</span><span class="n">response</span><span class="p">))</span> <span class="kn">from</span><span class="w"> </span><span class="kc">None</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">DynamoDBError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span> <span class="kn">from</span><span class="w"> </span><span class="kc">None</span>

        <span class="n">dynamodb_item</span> <span class="o">=</span> <span class="n">dynamodb_response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Item&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">dynamodb_item</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Convert the DynamoDB attribute values to deserialized values</span>
        <span class="n">response</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">key</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializer</span><span class="o">.</span><span class="n">deserialize_att</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">dynamodb_item</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">response</span></div>


<div class="viewcode-block" id="DynamoDB.put_item">
<a class="viewcode-back" href="../../../_apidoc/carlogtt_python_library.database.database_dynamo.html#carlogtt_python_library.database.database_dynamo.DynamoDB.put_item">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">put_item</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">partition_key_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">partition_key_value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PartitionKeyValue</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">auto_generate_partition_key_value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">items</span><span class="p">:</span> <span class="n">AttributeValue</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">AttributeValueDeserialized</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a new item. If an item that has the same primary key as</span>
<span class="sd">        the new item already exists in the specified table, the</span>
<span class="sd">        operation will fail.</span>

<span class="sd">        :param table: DynamoDB table name.</span>
<span class="sd">        :param partition_key_key: The key of the partition key.</span>
<span class="sd">        :param partition_key_value: The value of the partition key.</span>
<span class="sd">        :param auto_generate_partition_key_value: If set to True, this</span>
<span class="sd">            option instructs DynamoDB to automatically generate a</span>
<span class="sd">            partition key value based on a counter mechanism.</span>
<span class="sd">            For this to work, your table must contain a special item</span>
<span class="sd">            with its partition key value set to &#39;__PK_VALUE_COUNTER__&#39;.</span>
<span class="sd">            This item should have a numerical attribute named</span>
<span class="sd">            &#39;current_counter_value&#39;, which will be used and incremented</span>
<span class="sd">            as the basis for generating new partition key values.</span>
<span class="sd">        :param items: Additional items to add.</span>
<span class="sd">        :return: The stored DynamoDB Item deserialized.</span>
<span class="sd">        :raise DynamoDBError: If operation fails.</span>
<span class="sd">        :raise DynamoDBConflictError: If put item fails due to a</span>
<span class="sd">            conflict.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">partition_key_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">auto_generate_partition_key_value</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">DynamoDBError</span><span class="p">(</span>
                <span class="s2">&quot;If auto_generate_partition_key_value is enabled, a partition_key_value MUST NOT be&quot;</span>
                <span class="s2">&quot; passed in.&quot;</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="n">partition_key_value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">auto_generate_partition_key_value</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">DynamoDBError</span><span class="p">(</span>
                <span class="s2">&quot;If auto_generate_partition_key_value is disabled, a partition_key_value MUST be&quot;</span>
                <span class="s2">&quot; passed in.&quot;</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="n">partition_key_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">auto_generate_partition_key_value</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="c1"># If we don&#39;t need to increment the counter we just put the</span>
            <span class="c1"># item in the table</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">item_put</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_put_single_item</span><span class="p">(</span>
                    <span class="n">table</span><span class="o">=</span><span class="n">table</span><span class="p">,</span>
                    <span class="n">partition_key_key</span><span class="o">=</span><span class="n">partition_key_key</span><span class="p">,</span>
                    <span class="n">partition_key_value</span><span class="o">=</span><span class="n">partition_key_value</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">items</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">DynamoDBError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span> <span class="kn">from</span><span class="w"> </span><span class="kc">None</span>

        <span class="k">elif</span> <span class="n">partition_key_value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">auto_generate_partition_key_value</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># If we need to increment the counter we do it with an</span>
            <span class="c1"># atomic write</span>
            <span class="c1"># Put new item</span>
            <span class="n">put_in_db</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">AttributeValue</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s1">&#39;TableName&#39;</span><span class="p">:</span> <span class="n">table</span><span class="p">,</span>
                    <span class="s1">&#39;PartitionKeyKey&#39;</span><span class="p">:</span> <span class="n">partition_key_key</span><span class="p">,</span>
                    <span class="s1">&#39;AutoGeneratePartitionKeyValue&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s1">&#39;Items&#39;</span><span class="p">:</span> <span class="n">items</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">]</span>

            <span class="n">atomic_write_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atomic_writes</span><span class="p">(</span><span class="n">put</span><span class="o">=</span><span class="n">put_in_db</span><span class="p">)</span>

            <span class="c1"># If we get here it means that the item has been added</span>
            <span class="c1"># successfully therefore we return it</span>
            <span class="n">item_put</span> <span class="o">=</span> <span class="n">atomic_write_response</span><span class="p">[</span><span class="s1">&#39;Put&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">DynamoDBError</span><span class="p">(</span>
                <span class="s2">&quot;Unable to determine a valid operation with the provided &#39;partition_key_value&#39; and&quot;</span>
                <span class="s2">&quot; &#39;auto_generate_partition_key_value&#39;.&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">item_put</span></div>


<div class="viewcode-block" id="DynamoDB.update_item">
<a class="viewcode-back" href="../../../_apidoc/carlogtt_python_library.database.database_dynamo.html#carlogtt_python_library.database.database_dynamo.DynamoDB.update_item">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_item</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">partition_key</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">PartitionKeyValue</span><span class="p">],</span>
        <span class="n">condition_attribute</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">items</span><span class="p">:</span> <span class="n">AttributeValue</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">AttributeValueDeserialized</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Performs a strict update on an existing item in DynamoDB.</span>

<span class="sd">        This method enforces that the item with the specified partition</span>
<span class="sd">        key must already exist before updating. If the item does not</span>
<span class="sd">        exist, or if any specified condition does not match, the update</span>
<span class="sd">        fails with a `DynamoDBConflictError`. No new item is created in</span>
<span class="sd">        this scenario.</span>

<span class="sd">        Edits an existing itemâ€™s attributes. If</span>
<span class="sd">        condition_attribute_value is passed, the item will be updated</span>
<span class="sd">        only if condition_attribute_value is a match with the value</span>
<span class="sd">        stored in DynamoDB.</span>

<span class="sd">        :param table: DynamoDB table name.</span>
<span class="sd">        :param partition_key: DynamoDB partition key as dict of</span>
<span class="sd">            partition_key {key: value}.</span>
<span class="sd">        :param condition_attribute: DynamoDB attribute to matched as</span>
<span class="sd">            dict of attribute_to_match {key: value}. When sent to</span>
<span class="sd">            DynamoDB, the attribute will be as a condition to match.</span>
<span class="sd">        :param items: Values for items to be updated.</span>
<span class="sd">        :return: The updated DynamoDB Item deserialized.</span>
<span class="sd">        :raise DynamoDBError: If update fails.</span>
<span class="sd">        :raise DynamoDBConflictError: If update fails due to a conflict.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># items is an optional parameter by default as using the **</span>
        <span class="c1"># However, if no values are passed as **items we raise an</span>
        <span class="c1"># exception as there is nothing to update</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">items</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">DynamoDBError</span><span class="p">(</span>
                <span class="s2">&quot;No values to update were passed to the DynamoDB update_item_in_table method.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Initialize a dictionary with all the arguments to pass into</span>
        <span class="c1"># the DynamoDB update_item call</span>
        <span class="n">dynamodb_update_item_args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;TableName&#39;</span><span class="p">:</span> <span class="n">table</span><span class="p">,</span>
            <span class="s1">&#39;ReturnValues&#39;</span><span class="p">:</span> <span class="s1">&#39;ALL_OLD&#39;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># Serialize partition key</span>
        <span class="n">partition_key_key</span><span class="p">,</span> <span class="n">partition_key_value</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">partition_key</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
        <span class="n">partition_key_serialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializer</span><span class="o">.</span><span class="n">serialize_p_key</span><span class="p">(</span>
            <span class="n">partition_key_key</span><span class="p">,</span> <span class="n">partition_key_value</span>
        <span class="p">)</span>

        <span class="c1"># Serialize attributes</span>
        <span class="n">update_expression</span><span class="p">,</span> <span class="n">expression_attribute_names</span><span class="p">,</span> <span class="n">expression_attribute_values</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_serializer</span><span class="o">.</span><span class="n">serialize_update_items</span><span class="p">(</span><span class="o">**</span><span class="n">items</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Build a condition expression for â€œstrict updateâ€</span>
        <span class="n">dynamodb_update_item_args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span><span class="s1">&#39;ConditionExpression&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;attribute_exists(#</span><span class="si">{</span><span class="n">partition_key_key</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="n">expression_attribute_names</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="sa">f</span><span class="s2">&quot;#</span><span class="si">{</span><span class="n">partition_key_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">partition_key_key</span><span class="p">})</span>

        <span class="c1"># Check if a condition is required</span>
        <span class="k">if</span> <span class="n">condition_attribute</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Unpack condition attribute dictionary</span>
            <span class="c1"># We cant mutate the original dictionary because of the</span>
            <span class="c1"># retry decorator will need to run through it again in case</span>
            <span class="c1"># of failure</span>
            <span class="n">condition_attribute_key</span><span class="p">,</span> <span class="n">condition_attribute_value</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
                <span class="nb">iter</span><span class="p">(</span><span class="n">condition_attribute</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
            <span class="p">)</span>

            <span class="c1"># If condition attribute exists pass it to the DynamoDB call</span>
            <span class="n">dynamodb_update_item_args</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                <span class="s1">&#39;ConditionExpression&#39;</span><span class="p">:</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dynamodb_update_item_args</span><span class="p">[</span><span class="s1">&#39;ConditionExpression&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> AND&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; #</span><span class="si">{</span><span class="n">condition_attribute_key</span><span class="si">}</span><span class="s2"> = :condition_attribute_value_placeholder&quot;</span>
                <span class="p">)</span>
            <span class="p">})</span>

            <span class="c1"># #condition_attribute_key has to be passed</span>
            <span class="c1"># along the ExpressionAttributeNames because is used by the</span>
            <span class="c1"># ConditionExpression</span>
            <span class="n">expression_attribute_names</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;#</span><span class="si">{</span><span class="n">condition_attribute_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">condition_attribute_key</span>

            <span class="c1"># :condition_attribute_value_placeholder has to be passed</span>
            <span class="c1"># along the ExpressionAttributeValues because is used by the</span>
            <span class="c1"># ConditionExpression</span>
            <span class="n">expression_attribute_values</span><span class="p">[</span><span class="s1">&#39;:condition_attribute_value_placeholder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_serializer</span><span class="o">.</span><span class="n">serialize_att</span><span class="p">(</span><span class="n">condition_attribute_value</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Update DynamoDB call arguments</span>
        <span class="n">dynamodb_update_item_args</span><span class="p">[</span><span class="s1">&#39;Key&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">partition_key_serialized</span>
        <span class="n">dynamodb_update_item_args</span><span class="p">[</span><span class="s1">&#39;UpdateExpression&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">update_expression</span>
        <span class="n">dynamodb_update_item_args</span><span class="p">[</span><span class="s1">&#39;ExpressionAttributeNames&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">expression_attribute_names</span>
        <span class="n">dynamodb_update_item_args</span><span class="p">[</span><span class="s1">&#39;ExpressionAttributeValues&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">expression_attribute_values</span>

        <span class="n">module_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">dynamodb_update_item_args</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">utils</span><span class="o">.</span><span class="n">retry</span><span class="p">(</span><span class="n">exception_to_check</span><span class="o">=</span><span class="ne">Exception</span><span class="p">,</span> <span class="n">delay_secs</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">as</span> <span class="n">retryer</span><span class="p">:</span>
                <span class="n">dynamodb_response</span> <span class="o">=</span> <span class="n">retryer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">update_item</span><span class="p">,</span> <span class="o">**</span><span class="n">dynamodb_update_item_args</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">botocore</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;ConditionalCheckFailed&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">DynamoDBConflictError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="o">.</span><span class="n">response</span><span class="p">))</span> <span class="kn">from</span><span class="w"> </span><span class="kc">None</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">DynamoDBError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="o">.</span><span class="n">response</span><span class="p">))</span> <span class="kn">from</span><span class="w"> </span><span class="kc">None</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">DynamoDBError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span> <span class="kn">from</span><span class="w"> </span><span class="kc">None</span>

        <span class="c1"># If we get here it means that the item has been updated</span>
        <span class="c1"># successfully therefore we return it</span>
        <span class="n">old_item</span> <span class="o">=</span> <span class="n">dynamodb_response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Attributes&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">old_item_deserialized</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">key</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializer</span><span class="o">.</span><span class="n">deserialize_att</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">old_item</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="n">partition_key_key</span><span class="p">,</span> <span class="n">partition_key_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializer</span><span class="o">.</span><span class="n">deserialize_p_key</span><span class="p">(</span>
            <span class="n">partition_key_serialized</span>
        <span class="p">)</span>
        <span class="n">updated_item</span> <span class="o">=</span> <span class="p">{</span>
            <span class="o">**</span><span class="n">old_item_deserialized</span><span class="p">,</span>
            <span class="o">**</span><span class="n">items</span><span class="p">,</span>
            <span class="o">**</span><span class="p">{</span><span class="n">partition_key_key</span><span class="p">:</span> <span class="n">partition_key_value</span><span class="p">},</span>
        <span class="p">}</span>

        <span class="c1"># Because the **items in the updated_item dict is not serialized</span>
        <span class="c1"># we need to normalize the whole dict before returning a dict of</span>
        <span class="c1"># type dict[str, AttributeValueDeserialized]</span>
        <span class="n">updated_item_deserialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializer</span><span class="o">.</span><span class="n">normalize_item</span><span class="p">(</span><span class="n">updated_item</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">updated_item_deserialized</span></div>


<div class="viewcode-block" id="DynamoDB.upsert_item">
<a class="viewcode-back" href="../../../_apidoc/carlogtt_python_library.database.database_dynamo.html#carlogtt_python_library.database.database_dynamo.DynamoDB.upsert_item">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">upsert_item</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">partition_key</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">PartitionKeyValue</span><span class="p">],</span>
        <span class="n">condition_attribute</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">items</span><span class="p">:</span> <span class="n">AttributeValue</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">AttributeValueDeserialized</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Upsert-like operation.</span>

<span class="sd">        1. Tries to update an existing item (strict update).</span>
<span class="sd">        2. If that update fails because the item does not exist, it</span>
<span class="sd">        puts a brand-new item.</span>

<span class="sd">        :param table: DynamoDB table name.</span>
<span class="sd">        :param partition_key: DynamoDB partition key as dict of</span>
<span class="sd">            partition_key {key: value}.</span>
<span class="sd">        :param condition_attribute: DynamoDB attribute to matched as</span>
<span class="sd">            dict of attribute_to_match {key: value}. When sent to</span>
<span class="sd">            DynamoDB, the attribute will be as a condition to match.</span>
<span class="sd">        :param items: Values for items to be updated.</span>
<span class="sd">        :return: The updated DynamoDB Item deserialized.</span>
<span class="sd">        :raise DynamoDBError: If update fails.</span>
<span class="sd">        :raise DynamoDBConflictError: If update fails due to a conflict.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># items is an optional parameter by default as using the **</span>
        <span class="c1"># However, if no values are passed as **items we raise an</span>
        <span class="c1"># exception as there is nothing to update</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">items</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">DynamoDBError</span><span class="p">(</span>
                <span class="s2">&quot;No values to update were passed to the DynamoDB update_item_in_table method.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Initialize a dictionary with all the arguments to pass into</span>
        <span class="c1"># the DynamoDB update_item call</span>
        <span class="n">dynamodb_update_item_args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;TableName&#39;</span><span class="p">:</span> <span class="n">table</span><span class="p">,</span>
            <span class="s1">&#39;ReturnValues&#39;</span><span class="p">:</span> <span class="s1">&#39;ALL_OLD&#39;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># Serialize partition key</span>
        <span class="n">partition_key_key</span><span class="p">,</span> <span class="n">partition_key_value</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">partition_key</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
        <span class="n">partition_key_serialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializer</span><span class="o">.</span><span class="n">serialize_p_key</span><span class="p">(</span>
            <span class="n">partition_key_key</span><span class="p">,</span> <span class="n">partition_key_value</span>
        <span class="p">)</span>

        <span class="c1"># Serialize attributes</span>
        <span class="n">update_expression</span><span class="p">,</span> <span class="n">expression_attribute_names</span><span class="p">,</span> <span class="n">expression_attribute_values</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_serializer</span><span class="o">.</span><span class="n">serialize_update_items</span><span class="p">(</span><span class="o">**</span><span class="n">items</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Check if a condition is required</span>
        <span class="k">if</span> <span class="n">condition_attribute</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Unpack condition attribute dictionary</span>
            <span class="c1"># We cant mutate the original dictionary because of the</span>
            <span class="c1"># retry decorator will need to run through it again in case</span>
            <span class="c1"># of failure</span>
            <span class="n">condition_attribute_key</span><span class="p">,</span> <span class="n">condition_attribute_value</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
                <span class="nb">iter</span><span class="p">(</span><span class="n">condition_attribute</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
            <span class="p">)</span>

            <span class="c1"># If condition attribute exists pass it to the DynamoDB call</span>
            <span class="n">dynamodb_update_item_args</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                <span class="s1">&#39;ConditionExpression&#39;</span><span class="p">:</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;#</span><span class="si">{</span><span class="n">condition_attribute_key</span><span class="si">}</span><span class="s2"> = :condition_attribute_value_placeholder&quot;</span>
                <span class="p">)</span>
            <span class="p">})</span>

            <span class="c1"># #condition_attribute_key has to be passed</span>
            <span class="c1"># along the ExpressionAttributeNames because is used by the</span>
            <span class="c1"># ConditionExpression</span>
            <span class="n">expression_attribute_names</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;#</span><span class="si">{</span><span class="n">condition_attribute_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">condition_attribute_key</span>

            <span class="c1"># :condition_attribute_value_placeholder has to be passed</span>
            <span class="c1"># along the ExpressionAttributeValues because is used by the</span>
            <span class="c1"># ConditionExpression</span>
            <span class="n">expression_attribute_values</span><span class="p">[</span><span class="s1">&#39;:condition_attribute_value_placeholder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_serializer</span><span class="o">.</span><span class="n">serialize_att</span><span class="p">(</span><span class="n">condition_attribute_value</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Update DynamoDB call arguments</span>
        <span class="n">dynamodb_update_item_args</span><span class="p">[</span><span class="s1">&#39;Key&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">partition_key_serialized</span>
        <span class="n">dynamodb_update_item_args</span><span class="p">[</span><span class="s1">&#39;UpdateExpression&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">update_expression</span>
        <span class="n">dynamodb_update_item_args</span><span class="p">[</span><span class="s1">&#39;ExpressionAttributeNames&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">expression_attribute_names</span>
        <span class="n">dynamodb_update_item_args</span><span class="p">[</span><span class="s1">&#39;ExpressionAttributeValues&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">expression_attribute_values</span>

        <span class="n">module_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">dynamodb_update_item_args</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">utils</span><span class="o">.</span><span class="n">retry</span><span class="p">(</span><span class="n">exception_to_check</span><span class="o">=</span><span class="ne">Exception</span><span class="p">,</span> <span class="n">delay_secs</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">as</span> <span class="n">retryer</span><span class="p">:</span>
                <span class="n">dynamodb_response</span> <span class="o">=</span> <span class="n">retryer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">update_item</span><span class="p">,</span> <span class="o">**</span><span class="n">dynamodb_update_item_args</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">botocore</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;ConditionalCheckFailed&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">DynamoDBConflictError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="o">.</span><span class="n">response</span><span class="p">))</span> <span class="kn">from</span><span class="w"> </span><span class="kc">None</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">DynamoDBError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="o">.</span><span class="n">response</span><span class="p">))</span> <span class="kn">from</span><span class="w"> </span><span class="kc">None</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">DynamoDBError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span> <span class="kn">from</span><span class="w"> </span><span class="kc">None</span>

        <span class="c1"># If we get here it means that the item has been updated</span>
        <span class="c1"># successfully therefore we return it</span>
        <span class="n">old_item</span> <span class="o">=</span> <span class="n">dynamodb_response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Attributes&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">old_item_deserialized</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">key</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializer</span><span class="o">.</span><span class="n">deserialize_att</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">old_item</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="n">partition_key_key</span><span class="p">,</span> <span class="n">partition_key_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializer</span><span class="o">.</span><span class="n">deserialize_p_key</span><span class="p">(</span>
            <span class="n">partition_key_serialized</span>
        <span class="p">)</span>
        <span class="n">updated_item</span> <span class="o">=</span> <span class="p">{</span>
            <span class="o">**</span><span class="n">old_item_deserialized</span><span class="p">,</span>
            <span class="o">**</span><span class="n">items</span><span class="p">,</span>
            <span class="o">**</span><span class="p">{</span><span class="n">partition_key_key</span><span class="p">:</span> <span class="n">partition_key_value</span><span class="p">},</span>
        <span class="p">}</span>

        <span class="c1"># Because the **items in the updated_item dict is not serialized</span>
        <span class="c1"># we need to normalize the whole dict before returning a dict of</span>
        <span class="c1"># type dict[str, AttributeValueDeserialized]</span>
        <span class="n">updated_item_deserialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializer</span><span class="o">.</span><span class="n">normalize_item</span><span class="p">(</span><span class="n">updated_item</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">updated_item_deserialized</span></div>


<div class="viewcode-block" id="DynamoDB.delete_item">
<a class="viewcode-back" href="../../../_apidoc/carlogtt_python_library.database.database_dynamo.html#carlogtt_python_library.database.database_dynamo.DynamoDB.delete_item">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">delete_item</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">partition_key_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">partition_key_value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">PartitionKeyValue</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">PartitionKeyValue</span><span class="p">]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">AttributeValueDeserialized</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deletes item(s) in a table by primary key.</span>

<span class="sd">        If a single partition key value is provided, it deletes the</span>
<span class="sd">        corresponding item. If multiple partition key values are</span>
<span class="sd">        provided, it deletes all the corresponding items.</span>

<span class="sd">        :param table: DynamoDB table name.</span>
<span class="sd">        :param partition_key_key: The key of the partition key.</span>
<span class="sd">        :param partition_key_value: The value or an iterable of values</span>
<span class="sd">            of the partition key of the item or items to delete from</span>
<span class="sd">            DynamoDB.</span>
<span class="sd">        :return: A list of deleted DynamoDB Items deserialized.</span>
<span class="sd">        :raise DynamoDBError: If deletion fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Check if it&#39;s only one item to delete or many</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">partition_key_value</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
            <span class="n">partition_key_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">partition_key_value</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">partition_key_values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">partition_key_value</span><span class="p">)</span>

        <span class="c1"># Prepare response list</span>
        <span class="n">response</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">AttributeValueDeserialized</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">partition_key_value</span> <span class="ow">in</span> <span class="n">partition_key_values</span><span class="p">:</span>
            <span class="n">partition_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializer</span><span class="o">.</span><span class="n">serialize_p_key</span><span class="p">(</span><span class="n">partition_key_key</span><span class="p">,</span> <span class="n">partition_key_value</span><span class="p">)</span>

            <span class="c1"># Initialize a dictionary with all the arguments to pass</span>
            <span class="c1"># into the DynamoDB delete_item call</span>
            <span class="n">dynamodb_delete_item_args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;TableName&#39;</span><span class="p">:</span> <span class="n">table</span><span class="p">,</span>
                <span class="s1">&#39;Key&#39;</span><span class="p">:</span> <span class="n">partition_key</span><span class="p">,</span>
                <span class="s1">&#39;ReturnValues&#39;</span><span class="p">:</span> <span class="s1">&#39;ALL_OLD&#39;</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">utils</span><span class="o">.</span><span class="n">retry</span><span class="p">(</span><span class="n">exception_to_check</span><span class="o">=</span><span class="ne">Exception</span><span class="p">,</span> <span class="n">delay_secs</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">as</span> <span class="n">retryer</span><span class="p">:</span>
                    <span class="n">dynamodb_response</span> <span class="o">=</span> <span class="n">retryer</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">delete_item</span><span class="p">,</span> <span class="o">**</span><span class="n">dynamodb_delete_item_args</span>
                    <span class="p">)</span>

            <span class="k">except</span> <span class="n">botocore</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">DynamoDBError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="o">.</span><span class="n">response</span><span class="p">))</span> <span class="kn">from</span><span class="w"> </span><span class="kc">None</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">DynamoDBError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span> <span class="kn">from</span><span class="w"> </span><span class="kc">None</span>

            <span class="c1"># If we get here it means that the item has been deleted</span>
            <span class="c1"># successfully therefore we return it</span>
            <span class="n">old_item</span> <span class="o">=</span> <span class="n">dynamodb_response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Attributes&#39;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">old_item_deserialized</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">key</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializer</span><span class="o">.</span><span class="n">deserialize_att</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">old_item</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">}</span>
            <span class="n">partition_key_key</span><span class="p">,</span> <span class="n">partition_key_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializer</span><span class="o">.</span><span class="n">deserialize_p_key</span><span class="p">(</span>
                <span class="n">partition_key</span>
            <span class="p">)</span>
            <span class="n">deleted_item</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">old_item_deserialized</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="n">partition_key_key</span><span class="p">:</span> <span class="n">partition_key_value</span><span class="p">}}</span>

            <span class="n">response</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">deleted_item</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">response</span></div>


<div class="viewcode-block" id="DynamoDB.delete_item_att">
<a class="viewcode-back" href="../../../_apidoc/carlogtt_python_library.database.database_dynamo.html#carlogtt_python_library.database.database_dynamo.DynamoDB.delete_item_att">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">delete_item_att</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">partition_key_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">partition_key_value</span><span class="p">:</span> <span class="n">PartitionKeyValue</span><span class="p">,</span>
        <span class="n">attributes_to_delete</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">AttributeValueDeserialized</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deletes item specific values in a table by primary key.</span>

<span class="sd">        :param table: DynamoDB table name.</span>
<span class="sd">        :param partition_key_key: The key of the partition key.</span>
<span class="sd">        :param partition_key_value: The value of the partition key.</span>
<span class="sd">        :param attributes_to_delete: An iterable of specific attributes</span>
<span class="sd">            that are to be deleted from DynamoDB.</span>
<span class="sd">        :return: The updated DynamoDB Item deserialized.</span>
<span class="sd">        :raise DynamoDBError: If deletion fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">partition_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializer</span><span class="o">.</span><span class="n">serialize_p_key</span><span class="p">(</span><span class="n">partition_key_key</span><span class="p">,</span> <span class="n">partition_key_value</span><span class="p">)</span>

        <span class="n">attribute_updates</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">type_defs</span><span class="o">.</span><span class="n">AttributeValueUpdateTypeDef</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">item_value</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;Action&#39;</span><span class="p">:</span> <span class="s2">&quot;DELETE&quot;</span><span class="p">}</span> <span class="k">for</span> <span class="n">item_value</span> <span class="ow">in</span> <span class="n">attributes_to_delete</span>
        <span class="p">}</span>

        <span class="n">dynamodb_update_item_args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;TableName&#39;</span><span class="p">:</span> <span class="n">table</span><span class="p">,</span>
            <span class="s1">&#39;Key&#39;</span><span class="p">:</span> <span class="n">partition_key</span><span class="p">,</span>
            <span class="s1">&#39;AttributeUpdates&#39;</span><span class="p">:</span> <span class="n">attribute_updates</span><span class="p">,</span>
            <span class="s1">&#39;ReturnValues&#39;</span><span class="p">:</span> <span class="s1">&#39;ALL_NEW&#39;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">utils</span><span class="o">.</span><span class="n">retry</span><span class="p">(</span><span class="n">exception_to_check</span><span class="o">=</span><span class="ne">Exception</span><span class="p">,</span> <span class="n">delay_secs</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">as</span> <span class="n">retryer</span><span class="p">:</span>
                <span class="n">dynamodb_response</span> <span class="o">=</span> <span class="n">retryer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">update_item</span><span class="p">,</span> <span class="o">**</span><span class="n">dynamodb_update_item_args</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">botocore</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;ConditionalCheckFailed&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">DynamoDBConflictError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="o">.</span><span class="n">response</span><span class="p">))</span> <span class="kn">from</span><span class="w"> </span><span class="kc">None</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">DynamoDBError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="o">.</span><span class="n">response</span><span class="p">))</span> <span class="kn">from</span><span class="w"> </span><span class="kc">None</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">DynamoDBError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span> <span class="kn">from</span><span class="w"> </span><span class="kc">None</span>

        <span class="c1"># If we get here it means that the item has been updated</span>
        <span class="c1"># successfully therefore we return it</span>
        <span class="n">new_item</span> <span class="o">=</span> <span class="n">dynamodb_response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Attributes&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">new_item_deserialized</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">key</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializer</span><span class="o">.</span><span class="n">deserialize_att</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">new_item</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">new_item_deserialized</span></div>


<div class="viewcode-block" id="DynamoDB.atomic_writes">
<a class="viewcode-back" href="../../../_apidoc/carlogtt_python_library.database.database_dynamo.html#carlogtt_python_library.database.database_dynamo.DynamoDB.atomic_writes">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">atomic_writes</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">put</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">AttributeValue</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">update</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">AttributeValue</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">upsert</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">AttributeValue</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">delete</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">AttributeValue</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">condition_check</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">AttributeValue</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">AttributeValueDeserialized</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A synchronous write operation that groups up to 100 action</span>
<span class="sd">        requests. These actions can target items in different tables.</span>
<span class="sd">        The actions are completed atomically so that either all of them</span>
<span class="sd">        succeed, or all of them fail.</span>

<span class="sd">        :param put: Initiates a PutItem operation to write a new item.</span>
<span class="sd">            schema = {</span>
<span class="sd">            &#39;TableName&#39;: &quot;string DynamoDB Table Name&quot;,</span>
<span class="sd">            &#39;PartitionKeyKey&#39;: &quot;string of the PartitionKey key&quot;,</span>
<span class="sd">            &#39;PartitionKeyValue&#39;: &quot;OPTIONAL - partition key value&quot;,</span>
<span class="sd">            &#39;AutoGeneratePartitionKeyValue&#39;: &quot;OPTIONAL - bool&quot;,</span>
<span class="sd">            &#39;Items&#39;: &quot;dict containing all the items to put in DynamoDB&quot;,</span>
<span class="sd">            }</span>
<span class="sd">        :param update: Initiates an UpdateItem operation to update an</span>
<span class="sd">            existing item.</span>
<span class="sd">            schema = {</span>
<span class="sd">            &#39;TableName&#39;: &quot;string DynamoDB Table Name&quot;,</span>
<span class="sd">            &#39;PartitionKey&#39;: &quot;The partition key as dict of partition_key</span>
<span class="sd">            {key: value}&quot;,</span>
<span class="sd">            &#39;Items&#39;: &quot;dict containing all the values for items to be</span>
<span class="sd">            updated&quot;,</span>
<span class="sd">            &#39;ConditionAttribute&#39;: &quot;OPTIONAL - attribute to matched</span>
<span class="sd">            as dict of attribute_to_match {key: value}&quot;,</span>
<span class="sd">            }</span>
<span class="sd">        :param upsert: Initiates an UpdateOrInsertItem operation to</span>
<span class="sd">            update an existing item or insert if not in the table.</span>
<span class="sd">            schema = {</span>
<span class="sd">            &#39;TableName&#39;: &quot;string DynamoDB Table Name&quot;,</span>
<span class="sd">            &#39;PartitionKey&#39;: &quot;The partition key as dict of partition_key</span>
<span class="sd">            {key: value}&quot;,</span>
<span class="sd">            &#39;Items&#39;: &quot;dict containing all the values for items to be</span>
<span class="sd">            updated&quot;,</span>
<span class="sd">            &#39;ConditionAttribute&#39;: &quot;OPTIONAL - attribute to matched</span>
<span class="sd">            as dict of attribute_to_match {key: value}&quot;,</span>
<span class="sd">            }</span>
<span class="sd">        :param delete: Initiates a DeleteItem operation to delete an</span>
<span class="sd">            existing item.</span>
<span class="sd">            schema = {</span>
<span class="sd">            &#39;TableName&#39;: &quot;string DynamoDB Table Name&quot;,</span>
<span class="sd">            &#39;PartitionKey&#39;: &quot;The partition key as dict of partition_key</span>
<span class="sd">            {key: value}&quot;,</span>
<span class="sd">            }</span>
<span class="sd">        :param condition_check: Applies a condition to an item that is</span>
<span class="sd">            not being modified by the transaction. The condition must</span>
<span class="sd">            be satisfied for the transaction to succeed.</span>
<span class="sd">            schema = {</span>
<span class="sd">            &#39;TableName&#39;: &quot;string DynamoDB Table Name&quot;,</span>
<span class="sd">            &#39;PartitionKey&#39;: &quot;The partition key as dict of partition_key</span>
<span class="sd">            {key: value}&quot;,</span>
<span class="sd">            }</span>
<span class="sd">        :return: A dictionary with keys</span>
<span class="sd">            &#39;Put&#39;, &#39;Update&#39;, &#39;Delete&#39;, &#39;ConditionCheck&#39;,</span>
<span class="sd">            and a list of items writes to the DynamoDB in the same</span>
<span class="sd">            order as they were passed in.</span>
<span class="sd">            schema = {</span>
<span class="sd">            &#39;Put&#39;: &quot;list of items writes to DynamoDB&quot;,</span>
<span class="sd">            &#39;Update&#39;: &quot;list of items writes to DynamoDB&quot;,</span>
<span class="sd">            &#39;Upsert&#39;: &quot;list of items writes to DynamoDB&quot;,</span>
<span class="sd">            &#39;Delete&#39;: &quot;list of items writes to DynamoDB&quot;,</span>
<span class="sd">            &#39;ConditionCheck&#39;: &quot;list of items writes to DynamoDB&quot;,</span>
<span class="sd">            }</span>
<span class="sd">        :raise DynamoDBError: If atomic writes fail.</span>
<span class="sd">        :raise DynamoDBConflictError: If atomic writes fail due to a</span>
<span class="sd">            conflict.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Initialize missing arguments</span>
        <span class="n">put</span> <span class="o">=</span> <span class="n">put</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">update</span> <span class="o">=</span> <span class="n">update</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">upsert</span> <span class="o">=</span> <span class="n">upsert</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">delete</span> <span class="o">=</span> <span class="n">delete</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">condition_check</span> <span class="o">=</span> <span class="n">condition_check</span> <span class="ow">or</span> <span class="p">{}</span>

        <span class="c1"># Prepare the list of transactional items to be passed to the</span>
        <span class="c1"># DynamoDB call</span>
        <span class="n">transact_items</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">type_defs</span><span class="o">.</span><span class="n">TransactWriteItemTypeDef</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Prepare the response object</span>
        <span class="n">response</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">AttributeValueDeserialized</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;Put&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;Update&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;Upsert&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;Delete&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;ConditionCheck&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">}</span>

        <span class="n">module_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Atomic Writes in Table initial request - Put: </span><span class="si">{</span><span class="n">put</span><span class="si">}</span><span class="s2">, Update: </span><span class="si">{</span><span class="n">update</span><span class="si">}</span><span class="s2">, Delete:&quot;</span>
            <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">delete</span><span class="si">}</span><span class="s2">, ConditionCheck: </span><span class="si">{</span><span class="n">condition_check</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="n">transact_items</span><span class="p">,</span> <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atomic_writes_put</span><span class="p">(</span>
            <span class="n">put</span><span class="o">=</span><span class="n">put</span><span class="p">,</span>
            <span class="n">transact_items</span><span class="o">=</span><span class="n">transact_items</span><span class="p">,</span>
            <span class="n">response</span><span class="o">=</span><span class="n">response</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">transact_items</span><span class="p">,</span> <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atomic_writes_update</span><span class="p">(</span>
            <span class="n">update</span><span class="o">=</span><span class="n">update</span><span class="p">,</span>
            <span class="n">transact_items</span><span class="o">=</span><span class="n">transact_items</span><span class="p">,</span>
            <span class="n">response</span><span class="o">=</span><span class="n">response</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">transact_items</span><span class="p">,</span> <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atomic_writes_upsert</span><span class="p">(</span>
            <span class="n">upsert</span><span class="o">=</span><span class="n">upsert</span><span class="p">,</span>
            <span class="n">transact_items</span><span class="o">=</span><span class="n">transact_items</span><span class="p">,</span>
            <span class="n">response</span><span class="o">=</span><span class="n">response</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">transact_items</span><span class="p">,</span> <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atomic_writes_delete</span><span class="p">(</span>
            <span class="n">delete</span><span class="o">=</span><span class="n">delete</span><span class="p">,</span>
            <span class="n">transact_items</span><span class="o">=</span><span class="n">transact_items</span><span class="p">,</span>
            <span class="n">response</span><span class="o">=</span><span class="n">response</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">transact_items</span><span class="p">,</span> <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atomic_writes_condition_check</span><span class="p">(</span>
            <span class="n">condition_check</span><span class="o">=</span><span class="n">condition_check</span><span class="p">,</span>
            <span class="n">transact_items</span><span class="o">=</span><span class="n">transact_items</span><span class="p">,</span>
            <span class="n">response</span><span class="o">=</span><span class="n">response</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">module_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Atomic Writes in Table serialized request - </span><span class="si">{</span><span class="n">transact_items</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Make the DynamoDB atomic api call</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">utils</span><span class="o">.</span><span class="n">retry</span><span class="p">(</span><span class="n">exception_to_check</span><span class="o">=</span><span class="ne">Exception</span><span class="p">,</span> <span class="n">delay_secs</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">as</span> <span class="n">retryer</span><span class="p">:</span>
                <span class="n">retryer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">transact_write_items</span><span class="p">,</span> <span class="n">TransactItems</span><span class="o">=</span><span class="n">transact_items</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">botocore</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;ConditionalCheckFailed&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">DynamoDBConflictError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="o">.</span><span class="n">response</span><span class="p">))</span> <span class="kn">from</span><span class="w"> </span><span class="kc">None</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">DynamoDBError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="o">.</span><span class="n">response</span><span class="p">))</span> <span class="kn">from</span><span class="w"> </span><span class="kc">None</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">DynamoDBError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span> <span class="kn">from</span><span class="w"> </span><span class="kc">None</span>

        <span class="k">return</span> <span class="n">response</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_atomic_writes_put</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">put</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">AttributeValue</span><span class="p">]],</span>
        <span class="n">transact_items</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">type_defs</span><span class="o">.</span><span class="n">TransactWriteItemTypeDef</span><span class="p">],</span>
        <span class="n">response</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">AttributeValueDeserialized</span><span class="p">]]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span>
        <span class="nb">list</span><span class="p">[</span><span class="n">type_defs</span><span class="o">.</span><span class="n">TransactWriteItemTypeDef</span><span class="p">],</span>
        <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">AttributeValueDeserialized</span><span class="p">]]],</span>
    <span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A helper method to prepare the atomic writes for put items.</span>

<span class="sd">        :param put: A list of put items.</span>
<span class="sd">        :param transact_items:</span>
<span class="sd">        :param response:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Normalize each put item in the list for DynamoDB</span>
        <span class="c1"># transactional call</span>
        <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">put</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="s1">&#39;TableName&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="s1">&#39;Items&#39;</span><span class="p">],</span> <span class="n">Mapping</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="s1">&#39;PartitionKeyKey&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PartitionKeyValue&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;AutoGeneratePartitionKeyValue&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">DynamoDBError</span><span class="p">(</span>
                    <span class="s2">&quot;If AutoGeneratePartitionKeyValue is enabled, a PartitionKeyValue MUST NOT be&quot;</span>
                    <span class="s2">&quot; passed in.&quot;</span>
                <span class="p">)</span>

            <span class="k">elif</span> <span class="p">(</span>
                <span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PartitionKeyValue&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;AutoGeneratePartitionKeyValue&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span>
            <span class="p">):</span>
                <span class="c1"># This is the case where</span>
                <span class="c1"># el[&#39;PartitionKeyValue&#39;] = el[&#39;PartitionKeyValue&#39;]</span>
                <span class="k">pass</span>

            <span class="k">elif</span> <span class="p">(</span>
                <span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PartitionKeyValue&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;AutoGeneratePartitionKeyValue&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span>
            <span class="p">):</span>
                <span class="c1"># This is the case where we auto generate the id</span>
                <span class="n">current_counter_value</span><span class="p">,</span> <span class="n">last_modified_timestamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_atomic_counter</span><span class="p">(</span>
                    <span class="n">table</span><span class="o">=</span><span class="n">el</span><span class="p">[</span><span class="s1">&#39;TableName&#39;</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">new_counter_value</span> <span class="o">=</span> <span class="n">current_counter_value</span> <span class="o">+</span> <span class="mi">1</span>

                <span class="c1"># Check what is the type of the PartitionKey key of</span>
                <span class="c1"># the table</span>
                <span class="n">pk_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pk_type</span><span class="p">(</span><span class="n">table</span><span class="o">=</span><span class="n">el</span><span class="p">[</span><span class="s1">&#39;TableName&#39;</span><span class="p">])</span>

                <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">pk_type</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">auto_generate_pk_value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_counter_value</span><span class="p">)</span>

                <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">pk_type</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                    <span class="n">auto_generate_pk_value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_counter_value</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>

                <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">pk_type</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                    <span class="n">auto_generate_pk_value</span> <span class="o">=</span> <span class="n">new_counter_value</span>

            <span class="k">elif</span> <span class="p">(</span>
                <span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PartitionKeyValue&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;AutoGeneratePartitionKeyValue&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">DynamoDBError</span><span class="p">(</span>
                    <span class="s2">&quot;If AutoGeneratePartitionKeyValue is disabled, a PartitionKeyValue MUST be&quot;</span>
                    <span class="s2">&quot; passed in.&quot;</span>
                <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">DynamoDBError</span><span class="p">(</span>
                    <span class="s2">&quot;Unable to determine a valid operation with the provided PartitionKeyValue and&quot;</span>
                    <span class="s2">&quot; AutoGeneratePartitionKeyValue.&quot;</span>
                <span class="p">)</span>

            <span class="n">partition_key_value</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PartitionKeyValue&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">auto_generate_pk_value</span>

            <span class="c1"># If we don&#39;t need to increment the counter we just put the</span>
            <span class="c1"># item in the table</span>
            <span class="n">el_put_serialized</span><span class="p">:</span> <span class="n">type_defs</span><span class="o">.</span><span class="n">PutTypeDef</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;TableName&#39;</span><span class="p">:</span> <span class="n">el</span><span class="p">[</span><span class="s1">&#39;TableName&#39;</span><span class="p">],</span>
                <span class="s1">&#39;Item&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializer</span><span class="o">.</span><span class="n">serialize_put_items</span><span class="p">(</span>
                    <span class="o">**</span><span class="p">{</span><span class="n">el</span><span class="p">[</span><span class="s1">&#39;PartitionKeyKey&#39;</span><span class="p">]:</span> <span class="n">partition_key_value</span><span class="p">,</span> <span class="o">**</span><span class="n">el</span><span class="p">[</span><span class="s1">&#39;Items&#39;</span><span class="p">]}</span>
                <span class="p">),</span>
                <span class="s1">&#39;ConditionExpression&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;attribute_not_exists(</span><span class="si">{</span><span class="n">el</span><span class="p">[</span><span class="s1">&#39;PartitionKeyKey&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="c1"># Append the &#39;put&#39; item to the DynamoDB atomic call</span>
            <span class="n">transact_items</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;Put&#39;</span><span class="p">:</span> <span class="n">el_put_serialized</span><span class="p">})</span>

            <span class="c1"># Append the &#39;put&#39; item to the return list</span>
            <span class="n">response</span><span class="p">[</span><span class="s1">&#39;Put&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="n">key</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializer</span><span class="o">.</span><span class="n">deserialize_att</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">el_put_serialized</span><span class="p">[</span><span class="s1">&#39;Item&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">})</span>

            <span class="c1"># If we need to increment the counter we update the counter</span>
            <span class="k">if</span> <span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;AutoGeneratePartitionKeyValue&#39;</span><span class="p">):</span>
                <span class="c1"># Update the counter</span>
                <span class="n">counter_update_serialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_atomic_counter</span><span class="p">(</span>
                    <span class="n">table</span><span class="o">=</span><span class="n">el</span><span class="p">[</span><span class="s1">&#39;TableName&#39;</span><span class="p">],</span>
                    <span class="n">counter_value</span><span class="o">=</span><span class="n">new_counter_value</span><span class="p">,</span>
                    <span class="n">last_modified_timestamp</span><span class="o">=</span><span class="n">last_modified_timestamp</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># Append the &#39;update&#39; item to the DynamoDB atomic call</span>
                <span class="n">transact_items</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;Update&#39;</span><span class="p">:</span> <span class="n">counter_update_serialized</span><span class="p">})</span>

                <span class="c1"># Append the &#39;update&#39; item to the return list</span>
                <span class="n">updated_item</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">12</span><span class="p">]:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializer</span><span class="o">.</span><span class="n">deserialize_att</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">counter_update_serialized</span><span class="p">[</span><span class="s1">&#39;ExpressionAttributeValues&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="p">}</span>
                <span class="k">del</span> <span class="n">updated_item</span><span class="p">[</span><span class="s1">&#39;condition_attribute_value&#39;</span><span class="p">]</span>
                <span class="n">p_key_k</span><span class="p">,</span> <span class="n">p_key_v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializer</span><span class="o">.</span><span class="n">deserialize_p_key</span><span class="p">(</span>
                    <span class="n">counter_update_serialized</span><span class="p">[</span><span class="s1">&#39;Key&#39;</span><span class="p">]</span>  <span class="c1"># type: ignore</span>
                <span class="p">)</span>
                <span class="n">updated_item</span><span class="p">[</span><span class="n">p_key_k</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_key_v</span>
                <span class="n">response</span><span class="p">[</span><span class="s1">&#39;Update&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">updated_item</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">transact_items</span><span class="p">,</span> <span class="n">response</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_atomic_writes_update</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">update</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">AttributeValue</span><span class="p">]],</span>
        <span class="n">transact_items</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">type_defs</span><span class="o">.</span><span class="n">TransactWriteItemTypeDef</span><span class="p">],</span>
        <span class="n">response</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">AttributeValueDeserialized</span><span class="p">]]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span>
        <span class="nb">list</span><span class="p">[</span><span class="n">type_defs</span><span class="o">.</span><span class="n">TransactWriteItemTypeDef</span><span class="p">],</span>
        <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">AttributeValueDeserialized</span><span class="p">]]],</span>
    <span class="p">]:</span>
        <span class="c1"># Normalize each update item in the list for DynamoDB</span>
        <span class="c1"># transactional call</span>
        <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">update</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="s1">&#39;TableName&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="s1">&#39;Items&#39;</span><span class="p">],</span> <span class="n">Mapping</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="s1">&#39;PartitionKey&#39;</span><span class="p">],</span> <span class="n">MutableMapping</span><span class="p">)</span>

            <span class="n">partition_key_key</span><span class="p">,</span> <span class="n">partition_key_value</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="s1">&#39;PartitionKey&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">partition_key_value</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span>

            <span class="n">update_expression</span><span class="p">,</span> <span class="n">expression_attribute_names</span><span class="p">,</span> <span class="n">expression_attribute_values</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_serializer</span><span class="o">.</span><span class="n">serialize_update_items</span><span class="p">(</span><span class="o">**</span><span class="n">el</span><span class="p">[</span><span class="s1">&#39;Items&#39;</span><span class="p">])</span>
            <span class="p">)</span>

            <span class="c1"># Build a condition expression for â€œstrict updateâ€</span>
            <span class="n">condition_expression</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;attribute_exists(#</span><span class="si">{</span><span class="n">partition_key_key</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="n">expression_attribute_names</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="sa">f</span><span class="s2">&quot;#</span><span class="si">{</span><span class="n">partition_key_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">partition_key_key</span><span class="p">})</span>

            <span class="n">el_update_serialized</span><span class="p">:</span> <span class="n">type_defs</span><span class="o">.</span><span class="n">UpdateTypeDef</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;TableName&#39;</span><span class="p">:</span> <span class="n">el</span><span class="p">[</span><span class="s1">&#39;TableName&#39;</span><span class="p">],</span>
                <span class="s1">&#39;Key&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializer</span><span class="o">.</span><span class="n">serialize_p_key</span><span class="p">(</span><span class="n">partition_key_key</span><span class="p">,</span> <span class="n">partition_key_value</span><span class="p">),</span>
                <span class="s1">&#39;ConditionExpression&#39;</span><span class="p">:</span> <span class="n">condition_expression</span><span class="p">,</span>
                <span class="s1">&#39;UpdateExpression&#39;</span><span class="p">:</span> <span class="n">update_expression</span><span class="p">,</span>
                <span class="s1">&#39;ExpressionAttributeNames&#39;</span><span class="p">:</span> <span class="n">expression_attribute_names</span><span class="p">,</span>
                <span class="s1">&#39;ExpressionAttributeValues&#39;</span><span class="p">:</span> <span class="n">expression_attribute_values</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="c1"># Check if a condition is passed in</span>
            <span class="k">if</span> <span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ConditionAttribute&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Unpack condition attribute dictionary</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="s1">&#39;ConditionAttribute&#39;</span><span class="p">],</span> <span class="n">MutableMapping</span><span class="p">)</span>
                <span class="c1"># We cant mutate the original dictionary because of the</span>
                <span class="c1"># retry decorator will need to run through it again in</span>
                <span class="c1"># case of failure</span>
                <span class="n">condition_att_key</span><span class="p">,</span> <span class="n">condition_att_value</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
                    <span class="nb">iter</span><span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="s1">&#39;ConditionAttribute&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
                <span class="p">)</span>

                <span class="c1"># If condition attribute exists pass it to the DynamoDB</span>
                <span class="c1"># call</span>
                <span class="n">el_update_serialized</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                    <span class="s1">&#39;ConditionExpression&#39;</span><span class="p">:</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">el_update_serialized</span><span class="p">[</span><span class="s1">&#39;ConditionExpression&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> AND&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot; #</span><span class="si">{</span><span class="n">condition_att_key</span><span class="si">}</span><span class="s2"> = :condition_attribute_value_placeholder&quot;</span>
                    <span class="p">)</span>
                <span class="p">})</span>

                <span class="c1"># #condition_att_key has to be passed</span>
                <span class="c1"># along the ExpressionAttributeNames because is used by</span>
                <span class="c1"># the ConditionExpression</span>
                <span class="n">expression_attribute_names</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;#</span><span class="si">{</span><span class="n">condition_att_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">condition_att_key</span>

                <span class="c1"># :condition_attribute_value_placeholder has to be</span>
                <span class="c1"># passed along the ExpressionAttributeValues because</span>
                <span class="c1"># is used by the ConditionExpression</span>
                <span class="n">expression_attribute_values</span><span class="p">[</span><span class="s1">&#39;:condition_attribute_value_placeholder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_serializer</span><span class="o">.</span><span class="n">serialize_att</span><span class="p">(</span><span class="n">condition_att_value</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="c1"># Append the &#39;update&#39; item to the DynamoDB atomic call</span>
            <span class="n">transact_items</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;Update&#39;</span><span class="p">:</span> <span class="n">el_update_serialized</span><span class="p">})</span>

            <span class="c1"># Append the &#39;update&#39; item to the return list</span>
            <span class="n">updated_item</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">12</span><span class="p">]:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializer</span><span class="o">.</span><span class="n">deserialize_att</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">expression_attribute_values</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ConditionAttribute&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">updated_item</span><span class="p">[</span><span class="s1">&#39;condition_attribute_value&#39;</span><span class="p">]</span>
            <span class="n">p_key_k</span><span class="p">,</span> <span class="n">p_key_v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializer</span><span class="o">.</span><span class="n">deserialize_p_key</span><span class="p">(</span>
                <span class="n">el_update_serialized</span><span class="p">[</span><span class="s1">&#39;Key&#39;</span><span class="p">],</span>  <span class="c1"># type: ignore</span>
            <span class="p">)</span>
            <span class="n">updated_item</span><span class="p">[</span><span class="n">p_key_k</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_key_v</span>
            <span class="n">response</span><span class="p">[</span><span class="s1">&#39;Update&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">updated_item</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">transact_items</span><span class="p">,</span> <span class="n">response</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_atomic_writes_upsert</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">upsert</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">AttributeValue</span><span class="p">]],</span>
        <span class="n">transact_items</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">type_defs</span><span class="o">.</span><span class="n">TransactWriteItemTypeDef</span><span class="p">],</span>
        <span class="n">response</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">AttributeValueDeserialized</span><span class="p">]]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span>
        <span class="nb">list</span><span class="p">[</span><span class="n">type_defs</span><span class="o">.</span><span class="n">TransactWriteItemTypeDef</span><span class="p">],</span>
        <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">AttributeValueDeserialized</span><span class="p">]]],</span>
    <span class="p">]:</span>
        <span class="c1"># Normalize each upsert item in the list for DynamoDB</span>
        <span class="c1"># transactional call</span>
        <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">upsert</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="s1">&#39;TableName&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="s1">&#39;Items&#39;</span><span class="p">],</span> <span class="n">Mapping</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="s1">&#39;PartitionKey&#39;</span><span class="p">],</span> <span class="n">MutableMapping</span><span class="p">)</span>

            <span class="n">partition_key_key</span><span class="p">,</span> <span class="n">partition_key_value</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="s1">&#39;PartitionKey&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">partition_key_value</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span>

            <span class="n">update_expression</span><span class="p">,</span> <span class="n">expression_attribute_names</span><span class="p">,</span> <span class="n">expression_attribute_values</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_serializer</span><span class="o">.</span><span class="n">serialize_update_items</span><span class="p">(</span><span class="o">**</span><span class="n">el</span><span class="p">[</span><span class="s1">&#39;Items&#39;</span><span class="p">])</span>
            <span class="p">)</span>

            <span class="n">el_upsert_serialized</span><span class="p">:</span> <span class="n">type_defs</span><span class="o">.</span><span class="n">UpdateTypeDef</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;TableName&#39;</span><span class="p">:</span> <span class="n">el</span><span class="p">[</span><span class="s1">&#39;TableName&#39;</span><span class="p">],</span>
                <span class="s1">&#39;Key&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializer</span><span class="o">.</span><span class="n">serialize_p_key</span><span class="p">(</span><span class="n">partition_key_key</span><span class="p">,</span> <span class="n">partition_key_value</span><span class="p">),</span>
                <span class="s1">&#39;UpdateExpression&#39;</span><span class="p">:</span> <span class="n">update_expression</span><span class="p">,</span>
                <span class="s1">&#39;ExpressionAttributeNames&#39;</span><span class="p">:</span> <span class="n">expression_attribute_names</span><span class="p">,</span>
                <span class="s1">&#39;ExpressionAttributeValues&#39;</span><span class="p">:</span> <span class="n">expression_attribute_values</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="c1"># Check if a condition is passed in</span>
            <span class="k">if</span> <span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ConditionAttribute&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Unpack condition attribute dictionary</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="s1">&#39;ConditionAttribute&#39;</span><span class="p">],</span> <span class="n">MutableMapping</span><span class="p">)</span>
                <span class="c1"># We cant mutate the original dictionary because of the</span>
                <span class="c1"># retry decorator will need to run through it again in</span>
                <span class="c1"># case of failure</span>
                <span class="n">condition_att_key</span><span class="p">,</span> <span class="n">condition_att_value</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
                    <span class="nb">iter</span><span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="s1">&#39;ConditionAttribute&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
                <span class="p">)</span>

                <span class="c1"># If condition attribute exists pass it to the DynamoDB</span>
                <span class="c1"># call</span>
                <span class="n">el_upsert_serialized</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                    <span class="s1">&#39;ConditionExpression&#39;</span><span class="p">:</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;#</span><span class="si">{</span><span class="n">condition_att_key</span><span class="si">}</span><span class="s2"> = :condition_attribute_value_placeholder&quot;</span>
                    <span class="p">)</span>
                <span class="p">})</span>

                <span class="c1"># #condition_att_key has to be passed</span>
                <span class="c1"># along the ExpressionAttributeNames because is used by</span>
                <span class="c1"># the ConditionExpression</span>
                <span class="n">expression_attribute_names</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;#</span><span class="si">{</span><span class="n">condition_att_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">condition_att_key</span>

                <span class="c1"># :condition_attribute_value_placeholder has to be</span>
                <span class="c1"># passed along the ExpressionAttributeValues because</span>
                <span class="c1"># is used by the ConditionExpression</span>
                <span class="n">expression_attribute_values</span><span class="p">[</span><span class="s1">&#39;:condition_attribute_value_placeholder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_serializer</span><span class="o">.</span><span class="n">serialize_att</span><span class="p">(</span><span class="n">condition_att_value</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="c1"># Append the &#39;update&#39; item to the DynamoDB atomic call</span>
            <span class="n">transact_items</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;Update&#39;</span><span class="p">:</span> <span class="n">el_upsert_serialized</span><span class="p">})</span>

            <span class="c1"># Append the &#39;upsert&#39; item to the return list</span>
            <span class="n">upsert_item</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">12</span><span class="p">]:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializer</span><span class="o">.</span><span class="n">deserialize_att</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">expression_attribute_values</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ConditionAttribute&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">upsert_item</span><span class="p">[</span><span class="s1">&#39;condition_attribute_value&#39;</span><span class="p">]</span>
            <span class="n">p_key_k</span><span class="p">,</span> <span class="n">p_key_v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializer</span><span class="o">.</span><span class="n">deserialize_p_key</span><span class="p">(</span>
                <span class="n">el_upsert_serialized</span><span class="p">[</span><span class="s1">&#39;Key&#39;</span><span class="p">],</span>  <span class="c1"># type: ignore</span>
            <span class="p">)</span>
            <span class="n">upsert_item</span><span class="p">[</span><span class="n">p_key_k</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_key_v</span>
            <span class="n">response</span><span class="p">[</span><span class="s1">&#39;Upsert&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">upsert_item</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">transact_items</span><span class="p">,</span> <span class="n">response</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_atomic_writes_delete</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">delete</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">AttributeValue</span><span class="p">]],</span>
        <span class="n">transact_items</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">type_defs</span><span class="o">.</span><span class="n">TransactWriteItemTypeDef</span><span class="p">],</span>
        <span class="n">response</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">AttributeValueDeserialized</span><span class="p">]]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span>
        <span class="nb">list</span><span class="p">[</span><span class="n">type_defs</span><span class="o">.</span><span class="n">TransactWriteItemTypeDef</span><span class="p">],</span>
        <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">AttributeValueDeserialized</span><span class="p">]]],</span>
    <span class="p">]:</span>
        <span class="c1"># Normalize each delete item in the list for DynamoDB</span>
        <span class="c1"># transactional call</span>
        <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">delete</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="s1">&#39;TableName&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="s1">&#39;PartitionKey&#39;</span><span class="p">],</span> <span class="n">MutableMapping</span><span class="p">)</span>

            <span class="n">partition_key_key</span><span class="p">,</span> <span class="n">partition_key_value</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="s1">&#39;PartitionKey&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">partition_key_value</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span>

            <span class="n">el_delete_serialized</span><span class="p">:</span> <span class="n">type_defs</span><span class="o">.</span><span class="n">DeleteTypeDef</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;TableName&#39;</span><span class="p">:</span> <span class="n">el</span><span class="p">[</span><span class="s1">&#39;TableName&#39;</span><span class="p">],</span>
                <span class="s1">&#39;Key&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializer</span><span class="o">.</span><span class="n">serialize_p_key</span><span class="p">(</span><span class="n">partition_key_key</span><span class="p">,</span> <span class="n">partition_key_value</span><span class="p">),</span>
            <span class="p">}</span>

            <span class="c1"># Append the &#39;delete&#39; item to the DynamoDB atomic call</span>
            <span class="n">transact_items</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;Delete&#39;</span><span class="p">:</span> <span class="n">el_delete_serialized</span><span class="p">})</span>

            <span class="c1"># Append the &#39;delete&#39; item to the return list</span>
            <span class="n">response</span><span class="p">[</span><span class="s1">&#39;Delete&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="n">partition_key_key</span><span class="p">:</span> <span class="n">partition_key_value</span><span class="p">})</span>

        <span class="k">return</span> <span class="n">transact_items</span><span class="p">,</span> <span class="n">response</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_atomic_writes_condition_check</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">condition_check</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">AttributeValue</span><span class="p">]],</span>
        <span class="n">transact_items</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">type_defs</span><span class="o">.</span><span class="n">TransactWriteItemTypeDef</span><span class="p">],</span>
        <span class="n">response</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">AttributeValueDeserialized</span><span class="p">]]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span>
        <span class="nb">list</span><span class="p">[</span><span class="n">type_defs</span><span class="o">.</span><span class="n">TransactWriteItemTypeDef</span><span class="p">],</span>
        <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">AttributeValueDeserialized</span><span class="p">]]],</span>
    <span class="p">]:</span>
        <span class="c1"># Normalize each conditional check item in the list for DynamoDB</span>
        <span class="c1"># transactional call</span>
        <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">condition_check</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="s1">&#39;TableName&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="s1">&#39;PartitionKey&#39;</span><span class="p">],</span> <span class="n">MutableMapping</span><span class="p">)</span>

            <span class="n">partition_key_key</span><span class="p">,</span> <span class="n">partition_key_value</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="s1">&#39;PartitionKey&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">partition_key_value</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span>

            <span class="n">el_condition_check_serialized</span><span class="p">:</span> <span class="n">type_defs</span><span class="o">.</span><span class="n">ConditionCheckTypeDef</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;TableName&#39;</span><span class="p">:</span> <span class="n">el</span><span class="p">[</span><span class="s1">&#39;TableName&#39;</span><span class="p">],</span>
                <span class="s1">&#39;Key&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializer</span><span class="o">.</span><span class="n">serialize_p_key</span><span class="p">(</span><span class="n">partition_key_key</span><span class="p">,</span> <span class="n">partition_key_value</span><span class="p">),</span>
                <span class="c1"># TODO(carlogtt): not sure how to use the below yet</span>
                <span class="s1">&#39;ConditionExpression&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span>
                <span class="s1">&#39;ExpressionAttributeNames&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;string&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">},</span>
                <span class="s1">&#39;ExpressionAttributeValues&#39;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="p">}</span>

            <span class="c1"># Append the &#39;condition_check&#39; item to the DynamoDB atomic</span>
            <span class="c1"># call</span>
            <span class="n">transact_items</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;ConditionCheck&#39;</span><span class="p">:</span> <span class="n">el_condition_check_serialized</span><span class="p">})</span>

            <span class="c1"># Append the &#39;condition_check&#39; item to the return list</span>
            <span class="n">response</span><span class="p">[</span><span class="s1">&#39;ConditionCheck&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="n">partition_key_key</span><span class="p">:</span> <span class="n">partition_key_value</span><span class="p">})</span>

        <span class="k">return</span> <span class="n">transact_items</span><span class="p">,</span> <span class="n">response</span>

<div class="viewcode-block" id="DynamoDB.put_atomic_counter">
<a class="viewcode-back" href="../../../_apidoc/carlogtt_python_library.database.database_dynamo.html#carlogtt_python_library.database.database_dynamo.DynamoDB.put_atomic_counter">[docs]</a>
    <span class="nd">@utils</span><span class="o">.</span><span class="n">retry</span><span class="p">(</span><span class="n">exception_to_check</span><span class="o">=</span><span class="n">exceptions</span><span class="o">.</span><span class="n">DynamoDBError</span><span class="p">,</span> <span class="n">delay_secs</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">put_atomic_counter</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        In Amazon DynamoDB, there isn&#39;t an in-built auto-increment</span>
<span class="sd">        functionality like in SQL databases for generating record IDs</span>
<span class="sd">        (Primary Key values). However, we can achieve a similar outcome</span>
<span class="sd">        by managing an atomic counter.</span>
<span class="sd">        This method put the initial __PK_VALUE_COUNTER__ item in the</span>
<span class="sd">        table and set the value to 0.</span>
<span class="sd">        If the __PK_VALUE_COUNTER__ item already exists in the table</span>
<span class="sd">        then it does nothing.</span>

<span class="sd">        :param table: DynamoDB table name.</span>
<span class="sd">        :return: None</span>
<span class="sd">        :raise DynamoDBError: If operation fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Using the tableName_SysItems table for lookup</span>
        <span class="n">sys_table</span> <span class="o">=</span> <span class="n">table</span> <span class="o">+</span> <span class="s2">&quot;_SysItems&quot;</span>
        <span class="n">partition_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializer</span><span class="o">.</span><span class="n">serialize_p_key</span><span class="p">(</span><span class="s2">&quot;pk_id&quot;</span><span class="p">,</span> <span class="s2">&quot;__PK_VALUE_COUNTER__&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">dynamodb_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">get_item</span><span class="p">(</span><span class="n">TableName</span><span class="o">=</span><span class="n">sys_table</span><span class="p">,</span> <span class="n">Key</span><span class="o">=</span><span class="n">partition_key</span><span class="p">)</span>
            <span class="n">counter</span> <span class="o">=</span> <span class="n">dynamodb_response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Item&#39;</span><span class="p">)</span>

        <span class="k">except</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ResourceNotFoundException</span><span class="p">:</span>
            <span class="n">module_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Table: </span><span class="si">{</span><span class="n">sys_table</span><span class="si">}</span><span class="s2"> not found in DynamoDB, Creating it.&quot;</span><span class="p">)</span>

            <span class="c1"># Initialize a dictionary with all the arguments to pass</span>
            <span class="c1"># into the DynamoDB put_item call</span>
            <span class="n">dynamodb_create_table_args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;TableName&#39;</span><span class="p">:</span> <span class="n">sys_table</span><span class="p">,</span>
                <span class="s1">&#39;BillingMode&#39;</span><span class="p">:</span> <span class="s1">&#39;PAY_PER_REQUEST&#39;</span><span class="p">,</span>
                <span class="s1">&#39;AttributeDefinitions&#39;</span><span class="p">:</span> <span class="p">[{</span>
                    <span class="s1">&#39;AttributeName&#39;</span><span class="p">:</span> <span class="s1">&#39;pk_id&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;AttributeType&#39;</span><span class="p">:</span> <span class="s1">&#39;S&#39;</span><span class="p">,</span>
                <span class="p">}],</span>
                <span class="s1">&#39;KeySchema&#39;</span><span class="p">:</span> <span class="p">[{</span>
                    <span class="s1">&#39;AttributeName&#39;</span><span class="p">:</span> <span class="s1">&#39;pk_id&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;KeyType&#39;</span><span class="p">:</span> <span class="s1">&#39;HASH&#39;</span><span class="p">,</span>
                <span class="p">}],</span>
                <span class="s1">&#39;DeletionProtectionEnabled&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="o">**</span><span class="n">dynamodb_create_table_args</span><span class="p">)</span>

                <span class="c1"># Give it time to create the table</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>

                <span class="c1"># Setting the counter to None, so we can put the counter</span>
                <span class="c1"># item in the newly created table</span>
                <span class="n">counter</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">except</span> <span class="n">botocore</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">DynamoDBError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="o">.</span><span class="n">response</span><span class="p">))</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">DynamoDBError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span>

        <span class="k">except</span> <span class="n">botocore</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">DynamoDBError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="o">.</span><span class="n">response</span><span class="p">))</span> <span class="kn">from</span><span class="w"> </span><span class="kc">None</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">DynamoDBError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span> <span class="kn">from</span><span class="w"> </span><span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">counter</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">put_item</span><span class="p">(</span>
                <span class="n">table</span><span class="o">=</span><span class="n">sys_table</span><span class="p">,</span>
                <span class="n">partition_key_key</span><span class="o">=</span><span class="s2">&quot;pk_id&quot;</span><span class="p">,</span>
                <span class="n">partition_key_value</span><span class="o">=</span><span class="s2">&quot;__PK_VALUE_COUNTER__&quot;</span><span class="p">,</span>
                <span class="n">current_counter_value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">last_modified_timestamp</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time_ns</span><span class="p">(),</span>
            <span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_put_single_item</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">partition_key_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">partition_key_value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PartitionKeyValue</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">items</span><span class="p">:</span> <span class="n">AttributeValue</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">AttributeValueDeserialized</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Put the item in the table.</span>

<span class="sd">        :param table: DynamoDB table name.</span>
<span class="sd">        :param partition_key_key: The key of the partition key.</span>
<span class="sd">        :param partition_key_value: The value of the partition key.</span>
<span class="sd">        :param items: Additional items to add.</span>
<span class="sd">        :return: The stored DynamoDB Item deserialized.</span>
<span class="sd">        :raise DynamoDBError: If operation fails.</span>
<span class="sd">        :raise DynamoDBConflictError: If put item fails due to a</span>
<span class="sd">            conflict.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">partition_key_value</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span>

        <span class="n">partition_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializer</span><span class="o">.</span><span class="n">serialize_p_key</span><span class="p">(</span><span class="n">partition_key_key</span><span class="p">,</span> <span class="n">partition_key_value</span><span class="p">)</span>
        <span class="n">additional_items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializer</span><span class="o">.</span><span class="n">serialize_put_items</span><span class="p">(</span><span class="o">**</span><span class="n">items</span><span class="p">)</span>
        <span class="n">all_items_serialized</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">additional_items</span><span class="p">,</span> <span class="o">**</span><span class="n">partition_key</span><span class="p">}</span>

        <span class="c1"># Initialize a dictionary with all the arguments to pass into</span>
        <span class="c1"># the DynamoDB put_item call</span>
        <span class="n">dynamodb_put_item_args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;TableName&#39;</span><span class="p">:</span> <span class="n">table</span><span class="p">,</span>
            <span class="s1">&#39;Item&#39;</span><span class="p">:</span> <span class="n">all_items_serialized</span><span class="p">,</span>
            <span class="s1">&#39;ConditionExpression&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;attribute_not_exists(</span><span class="si">{</span><span class="n">partition_key_key</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">utils</span><span class="o">.</span><span class="n">retry</span><span class="p">(</span><span class="n">exception_to_check</span><span class="o">=</span><span class="ne">Exception</span><span class="p">,</span> <span class="n">delay_secs</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">as</span> <span class="n">retryer</span><span class="p">:</span>
                <span class="n">retryer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">put_item</span><span class="p">,</span> <span class="o">**</span><span class="n">dynamodb_put_item_args</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">botocore</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;ConditionalCheckFailed&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">DynamoDBConflictError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="o">.</span><span class="n">response</span><span class="p">))</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">DynamoDBError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="o">.</span><span class="n">response</span><span class="p">))</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">DynamoDBError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span>

        <span class="c1"># If we get here it means that the item has been added</span>
        <span class="c1"># successfully therefore we return it</span>
        <span class="n">item_put</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">key</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializer</span><span class="o">.</span><span class="n">deserialize_att</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">all_items_serialized</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">item_put</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_atomic_counter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method will get the value of the atomic counter.</span>

<span class="sd">        :param table: DynamoDB table name.</span>
<span class="sd">        :return: Counter value and last_modified_timestamp as tuple.</span>
<span class="sd">        :raise DynamoDBError: If counter not found.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Using the tableName_SysItems table for lookup</span>
        <span class="n">sys_table</span> <span class="o">=</span> <span class="n">table</span> <span class="o">+</span> <span class="s2">&quot;_SysItems&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_item</span><span class="p">(</span>
                <span class="n">table</span><span class="o">=</span><span class="n">sys_table</span><span class="p">,</span>
                <span class="n">partition_key_key</span><span class="o">=</span><span class="s2">&quot;pk_id&quot;</span><span class="p">,</span>
                <span class="n">partition_key_value</span><span class="o">=</span><span class="s2">&quot;__PK_VALUE_COUNTER__&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">assert</span> <span class="n">item</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

            <span class="n">current_counter_value</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;current_counter_value&#39;</span><span class="p">]</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">current_counter_value</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>

            <span class="n">last_modified_timestamp</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;last_modified_timestamp&#39;</span><span class="p">]</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">last_modified_timestamp</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">DynamoDBError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;table: </span><span class="si">{</span><span class="n">table</span><span class="si">!r}</span><span class="s2"> doesn&#39;t have the &#39;__PK_VALUE_COUNTER__&#39; item, call&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">put_atomic_counter</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39; to create one.&quot;</span>
            <span class="p">)</span>

        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">DynamoDBError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Item &#39;__PK_VALUE_COUNTER__&#39; in table: </span><span class="si">{</span><span class="n">table</span><span class="si">!r}</span><span class="s2"> is missing some or all of the&quot;</span>
                <span class="s2">&quot; mandatory attributes: &#39;current_counter_value&#39; and &#39;last_modified_timestamp&#39;.&quot;</span>
            <span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;ResourceNotFoundException&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">DynamoDBError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;&#39;__PK_VALUE_COUNTER__&#39; not found as table: &#39;</span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2">_SysItems&#39; doesn&#39;t exists,&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; call &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">put_atomic_counter</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(&#39;</span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2">&#39;)&#39; to create one.&quot;</span>
                <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>

        <span class="k">return</span> <span class="n">current_counter_value</span><span class="p">,</span> <span class="n">last_modified_timestamp</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_set_atomic_counter</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">counter_value</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">last_modified_timestamp</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">type_defs</span><span class="o">.</span><span class="n">UpdateTypeDef</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method will prepare an atomic update dictionary.</span>

<span class="sd">        :param table: DynamoDB table name.</span>
<span class="sd">        :param counter_value: The new value to se to the counter.</span>
<span class="sd">        :param last_modified_timestamp: The last modified timestamp to</span>
<span class="sd">            use as condition expression.</span>
<span class="sd">        :return: An atomic update dictionary.</span>
<span class="sd">        :raise DynamoDBError: If operation fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Using the tableName_SysItems table for lookup</span>
        <span class="n">sys_table</span> <span class="o">=</span> <span class="n">table</span> <span class="o">+</span> <span class="s2">&quot;_SysItems&quot;</span>

        <span class="c1"># Update the counter</span>
        <span class="n">update_expression</span><span class="p">,</span> <span class="n">expression_attribute_names</span><span class="p">,</span> <span class="n">expression_attribute_values</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_serializer</span><span class="o">.</span><span class="n">serialize_update_items</span><span class="p">(</span><span class="o">**</span><span class="p">{</span>
                <span class="s1">&#39;current_counter_value&#39;</span><span class="p">:</span> <span class="n">counter_value</span><span class="p">,</span>
                <span class="s1">&#39;last_modified_timestamp&#39;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time_ns</span><span class="p">(),</span>
            <span class="p">})</span>
        <span class="p">)</span>

        <span class="c1"># :condition_attribute_value_placeholder has to be</span>
        <span class="c1"># passed along the ExpressionAttributeValues because</span>
        <span class="c1"># is used by the ConditionExpression</span>
        <span class="n">expression_attribute_values</span><span class="p">[</span><span class="s1">&#39;:condition_attribute_value_placeholder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_serializer</span><span class="o">.</span><span class="n">serialize_att</span><span class="p">(</span><span class="n">last_modified_timestamp</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">el_update_serialized</span><span class="p">:</span> <span class="n">type_defs</span><span class="o">.</span><span class="n">UpdateTypeDef</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;TableName&#39;</span><span class="p">:</span> <span class="n">sys_table</span><span class="p">,</span>
            <span class="s1">&#39;Key&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializer</span><span class="o">.</span><span class="n">serialize_p_key</span><span class="p">(</span><span class="s2">&quot;pk_id&quot;</span><span class="p">,</span> <span class="s2">&quot;__PK_VALUE_COUNTER__&quot;</span><span class="p">),</span>
            <span class="s1">&#39;UpdateExpression&#39;</span><span class="p">:</span> <span class="n">update_expression</span><span class="p">,</span>
            <span class="s1">&#39;ExpressionAttributeNames&#39;</span><span class="p">:</span> <span class="n">expression_attribute_names</span><span class="p">,</span>
            <span class="s1">&#39;ExpressionAttributeValues&#39;</span><span class="p">:</span> <span class="n">expression_attribute_values</span><span class="p">,</span>
            <span class="s1">&#39;ConditionExpression&#39;</span><span class="p">:</span> <span class="p">(</span>
                <span class="s2">&quot;#last_modified_timestamp = :condition_attribute_value_placeholder&quot;</span>
            <span class="p">),</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">el_update_serialized</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_pk_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="nb">bytes</span><span class="p">],</span> <span class="nb">type</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">type</span><span class="p">[</span><span class="nb">float</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Scan the table and return the type of the PartitionKeyItem Key.</span>

<span class="sd">        :param table: DynamoDB table name.</span>
<span class="sd">        :return: The type of the PartitionKey key.</span>
<span class="sd">        :raise DynamoDBError: If operation fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Initialize values to prevent UnboundLocalError</span>
        <span class="n">partition_key_key</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">partition_key_key_type</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">utils</span><span class="o">.</span><span class="n">retry</span><span class="p">(</span><span class="n">exception_to_check</span><span class="o">=</span><span class="ne">Exception</span><span class="p">,</span> <span class="n">delay_secs</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">as</span> <span class="n">retryer</span><span class="p">:</span>
                <span class="n">dynamodb_response</span> <span class="o">=</span> <span class="n">retryer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">describe_table</span><span class="p">,</span> <span class="n">TableName</span><span class="o">=</span><span class="n">table</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">botocore</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">DynamoDBError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="o">.</span><span class="n">response</span><span class="p">))</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">DynamoDBError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span>

        <span class="c1"># Get the PartitionKey Key</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">schemas</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dynamodb_response</span><span class="p">[</span><span class="s1">&#39;Table&#39;</span><span class="p">][</span><span class="s1">&#39;KeySchema&#39;</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">schemas</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;KeyType&#39;</span> <span class="ow">and</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;HASH&#39;</span><span class="p">:</span>
                    <span class="n">partition_key_key</span> <span class="o">=</span> <span class="n">dynamodb_response</span><span class="p">[</span><span class="s1">&#39;Table&#39;</span><span class="p">][</span><span class="s1">&#39;KeySchema&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">][</span>
                        <span class="s1">&#39;AttributeName&#39;</span>
                    <span class="p">]</span>

        <span class="c1"># Get the PartitionKey Key Type</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">attributes</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dynamodb_response</span><span class="p">[</span><span class="s1">&#39;Table&#39;</span><span class="p">][</span><span class="s1">&#39;AttributeDefinitions&#39;</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">attributes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;AttributeName&#39;</span> <span class="ow">and</span> <span class="n">v</span> <span class="o">==</span> <span class="n">partition_key_key</span><span class="p">:</span>
                    <span class="n">partition_key_key_type</span> <span class="o">=</span> <span class="n">dynamodb_response</span><span class="p">[</span><span class="s1">&#39;Table&#39;</span><span class="p">][</span><span class="s1">&#39;AttributeDefinitions&#39;</span><span class="p">][</span>
                        <span class="n">idx</span>
                    <span class="p">][</span><span class="s1">&#39;AttributeType&#39;</span><span class="p">]</span>

        <span class="c1"># Convert to Python type and return</span>
        <span class="k">if</span> <span class="n">partition_key_key_type</span> <span class="o">==</span> <span class="s1">&#39;S&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">str</span>

        <span class="k">elif</span> <span class="n">partition_key_key_type</span> <span class="o">==</span> <span class="s1">&#39;B&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">bytes</span>

        <span class="k">elif</span> <span class="n">partition_key_key_type</span> <span class="o">==</span> <span class="s1">&#39;N&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">float</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">DynamoDBError</span><span class="p">(</span><span class="s2">&quot;PartitionKey Key Type not found&quot;</span><span class="p">)</span></div>



<span class="k">class</span><span class="w"> </span><span class="nc">DynamoDbSerializer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    DynamoDbSerializer is a utility class for serializing and</span>
<span class="sd">    deserializing Python data types to DynamoDB compatible formats and</span>
<span class="sd">    vice versa.</span>
<span class="sd">    It provides methods for converting Python objects to DynamoDB</span>
<span class="sd">    attributes and for converting DynamoDB attributes back to Python</span>
<span class="sd">    objects.</span>

<span class="sd">    This class is useful for preparing data for storage in a DynamoDB</span>
<span class="sd">    table, and for reading data back into Python objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">string_utils</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">StringUtils</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">serialize_att</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attribute_value</span><span class="p">:</span> <span class="n">AttributeValue</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">type_defs</span><span class="o">.</span><span class="n">AttributeValueTypeDef</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Serialize a Python data type into a format suitable for</span>
<span class="sd">        AWS DynamoDB.</span>
<span class="sd">        Transforms a Python data type into a format that is compatible</span>
<span class="sd">        with AWS DynamoDB by mapping it into its corresponding DynamoDB</span>
<span class="sd">        data type.</span>

<span class="sd">        :param attribute_value: The attribute value to be serialized.</span>
<span class="sd">        :return: A dictionary containing the serialized attribute and</span>
<span class="sd">            its corresponding DynamoDB data type descriptor.</span>
<span class="sd">            i.e. &quot;string&quot; -&gt; {&quot;S&quot;: &quot;string&quot;}</span>
<span class="sd">        :raise DynamoDBError: If the provided attribute_value type is</span>
<span class="sd">            not supported.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">attribute_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;NULL&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attribute_value</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;BOOL&quot;</span><span class="p">:</span> <span class="n">attribute_value</span><span class="p">}</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attribute_value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="n">attribute_value</span><span class="p">}</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attribute_value</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attribute_value</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="n">attribute_value</span><span class="p">}</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attribute_value</span><span class="p">,</span> <span class="p">(</span><span class="n">numbers</span><span class="o">.</span><span class="n">Real</span><span class="p">,</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">)):</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">attribute_value</span><span class="p">)}</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attribute_value</span><span class="p">,</span> <span class="nb">set</span><span class="p">):</span>
            <span class="c1"># Check the set contains at least one element</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">set_el_sample</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">attribute_value</span><span class="p">))</span>

            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">DynamoDBError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Object of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">attribute_value</span><span class="p">)</span><span class="si">!r}</span><span class="s2"> for </span><span class="si">{</span><span class="n">attribute_value</span><span class="si">!r}</span><span class="s2"> is not&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; supported by DynamoDB serialization because </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">attribute_value</span><span class="p">)</span><span class="si">!r}</span><span class="s2"> empty.&quot;</span>
                <span class="p">)</span>

            <span class="c1"># Check if set is homogeneous</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">set_el_sample</span><span class="p">))</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">attribute_value</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">DynamoDBError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Object of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">attribute_value</span><span class="p">)</span><span class="si">!r}</span><span class="s2"> for </span><span class="si">{</span><span class="n">attribute_value</span><span class="si">!r}</span><span class="s2"> is not&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; supported by DynamoDB serialization because </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">attribute_value</span><span class="p">)</span><span class="si">!r}</span><span class="s2"> must&quot;</span>
                    <span class="s2">&quot; be homogeneous.&quot;</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">set_el_sample</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;SS&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">attribute_value</span><span class="p">)}</span>  <span class="c1"># type: ignore</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">set_el_sample</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;BS&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">attribute_value</span><span class="p">)}</span>  <span class="c1"># type: ignore</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">set_el_sample</span><span class="p">,</span> <span class="p">(</span><span class="n">numbers</span><span class="o">.</span><span class="n">Real</span><span class="p">,</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">)):</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;NS&quot;</span><span class="p">:</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">el</span><span class="p">)</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">attribute_value</span><span class="p">]}</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">DynamoDBError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Object of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">attribute_value</span><span class="p">)</span><span class="si">!r}</span><span class="s2"> for </span><span class="si">{</span><span class="n">attribute_value</span><span class="si">!r}</span><span class="s2"> is not&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; supported by DynamoDB </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">attribute_value</span><span class="p">)</span><span class="si">!r}</span><span class="s2">.&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">attribute_value</span><span class="p">)</span><span class="si">!r}</span><span class="s2"> must be homogeneous of [str | bytes | int | float]&quot;</span>
                <span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attribute_value</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">):</span>
            <span class="n">list_value</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">attribute_value</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">el</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">list_value</span><span class="p">):</span>
                <span class="n">list_value</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serialize_att</span><span class="p">(</span><span class="n">el</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;L&quot;</span><span class="p">:</span> <span class="n">list_value</span><span class="p">}</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attribute_value</span><span class="p">,</span> <span class="n">MutableMapping</span><span class="p">):</span>
            <span class="n">dict_value</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">attribute_value</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">dict_value</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">dict_value</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serialize_att</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;M&quot;</span><span class="p">:</span> <span class="n">dict_value</span><span class="p">}</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">DynamoDBError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Object of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">attribute_value</span><span class="p">)</span><span class="si">!r}</span><span class="s2"> for </span><span class="si">{</span><span class="n">attribute_value</span><span class="si">!r}</span><span class="s2"> is not supported&quot;</span>
                <span class="s2">&quot; by DynamoDB serialization.&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">deserialize_att</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dynamodb_attribute</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">type_defs</span><span class="o">.</span><span class="n">AttributeValueTypeDef</span><span class="p">,</span> <span class="n">PartitionKeyTypeDef</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AttributeValueDeserialized</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deserialize an AWS DynamoDB data type into its corresponding</span>
<span class="sd">        Python data type. Transforms an AWS DynamoDB attribute into a</span>
<span class="sd">        Python data type by identifying the DynamoDB data type</span>
<span class="sd">        descriptor and mapping it to its corresponding Python data type.</span>

<span class="sd">        :param dynamodb_attribute: The DynamoDB attribute to be</span>
<span class="sd">            deserialized. It should be a dictionary containing the</span>
<span class="sd">            DynamoDB data type descriptor and the attribute value.</span>
<span class="sd">        :return: The deserialized Python data type.</span>
<span class="sd">            i.e. i.e. {&quot;S&quot;: &quot;string&quot;} -&gt; &quot;string&quot;</span>
<span class="sd">        :raise DynamoDBError: If the provided dynamodb_attribute is not</span>
<span class="sd">            supported for deserialization.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># The sentinel value is a unique object identifier used as a</span>
        <span class="c1"># default fallback when querying dictionary keys during the</span>
        <span class="c1"># deserialization process. The unique ensures that the</span>
        <span class="c1"># sentinel is not accidentally found in `dynamodb_attribute`</span>
        <span class="c1"># dictionary values. Utilizing sentinel helps in distinguishing</span>
        <span class="c1"># between a None value and absence of a key. During the</span>
        <span class="c1"># deserialization, if the `.get()` method returns the sentinel,</span>
        <span class="c1"># it implies the key was not found in `dynamodb_attribute`;</span>
        <span class="c1"># otherwise, it returns the actual value (which might be None</span>
        <span class="c1"># or other falsy values) related to the looked-up key.</span>
        <span class="n">sentinel</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">dynamodb_attribute</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;NULL&quot;</span><span class="p">,</span> <span class="n">sentinel</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">sentinel</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">elif</span> <span class="n">dynamodb_attribute</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;BOOL&quot;</span><span class="p">,</span> <span class="n">sentinel</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">sentinel</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">dynamodb_attribute</span><span class="p">[</span><span class="s2">&quot;BOOL&quot;</span><span class="p">])</span>  <span class="c1"># type: ignore</span>

        <span class="k">elif</span> <span class="n">dynamodb_attribute</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="n">sentinel</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">sentinel</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">dynamodb_attribute</span><span class="p">[</span><span class="s2">&quot;S&quot;</span><span class="p">])</span>

        <span class="k">elif</span> <span class="n">dynamodb_attribute</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="n">sentinel</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">sentinel</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dynamodb_attribute</span><span class="p">[</span><span class="s2">&quot;B&quot;</span><span class="p">]</span>

        <span class="k">elif</span> <span class="n">dynamodb_attribute</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="n">sentinel</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">sentinel</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">dynamodb_attribute</span><span class="p">[</span><span class="s2">&quot;N&quot;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">dynamodb_attribute</span><span class="p">[</span><span class="s2">&quot;N&quot;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">dynamodb_attribute</span><span class="p">[</span><span class="s2">&quot;N&quot;</span><span class="p">])</span>

        <span class="k">elif</span> <span class="n">dynamodb_attribute</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SS&quot;</span><span class="p">,</span> <span class="n">sentinel</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">sentinel</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">dynamodb_attribute</span><span class="p">[</span><span class="s2">&quot;SS&quot;</span><span class="p">])</span>  <span class="c1"># type: ignore</span>

        <span class="k">elif</span> <span class="n">dynamodb_attribute</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;BS&quot;</span><span class="p">,</span> <span class="n">sentinel</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">sentinel</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">dynamodb_attribute</span><span class="p">[</span><span class="s2">&quot;BS&quot;</span><span class="p">])</span>  <span class="c1"># type: ignore</span>

        <span class="k">elif</span> <span class="n">dynamodb_attribute</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;NS&quot;</span><span class="p">,</span> <span class="n">sentinel</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">sentinel</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;.&quot;</span> <span class="ow">in</span> <span class="n">dynamodb_attribute</span><span class="p">[</span><span class="s2">&quot;NS&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>  <span class="c1"># type: ignore</span>
                <span class="k">return</span> <span class="p">{</span><span class="nb">float</span><span class="p">(</span><span class="n">el</span><span class="p">)</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">dynamodb_attribute</span><span class="p">[</span><span class="s2">&quot;NS&quot;</span><span class="p">]}</span>  <span class="c1"># type: ignore</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="nb">int</span><span class="p">(</span><span class="n">el</span><span class="p">)</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">dynamodb_attribute</span><span class="p">[</span><span class="s2">&quot;NS&quot;</span><span class="p">]}</span>  <span class="c1"># type: ignore</span>

        <span class="k">elif</span> <span class="n">dynamodb_attribute</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;L&quot;</span><span class="p">,</span> <span class="n">sentinel</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">sentinel</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">deserialize_att</span><span class="p">(</span><span class="n">el</span><span class="p">)</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">dynamodb_attribute</span><span class="p">[</span><span class="s2">&quot;L&quot;</span><span class="p">]]</span>  <span class="c1"># type: ignore</span>

        <span class="k">elif</span> <span class="n">dynamodb_attribute</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;M&quot;</span><span class="p">,</span> <span class="n">sentinel</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">sentinel</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="n">key</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">deserialize_att</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">dynamodb_attribute</span><span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>  <span class="c1"># type: ignore</span>
            <span class="p">}</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">DynamoDBError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Object </span><span class="si">{</span><span class="n">dynamodb_attribute</span><span class="si">!r}</span><span class="s2"> of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">dynamodb_attribute</span><span class="p">)</span><span class="si">!r}</span><span class="s2"> is not&quot;</span>
                <span class="s2">&quot; supported for DynamoDB deserialization.&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">serialize_p_key</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">partition_key_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">partition_key_value</span><span class="p">:</span> <span class="n">PartitionKeyValue</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PartitionKeyItem</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a serialized DynamoDB partition key.</span>

<span class="sd">        :param partition_key_key: The key of the partition key.</span>
<span class="sd">        :param partition_key_value: The value of the partition key.</span>
<span class="sd">        :return: Serialized partition key.</span>
<span class="sd">            i.e. {&quot;id&quot;: {&quot;S&quot;: &quot;string&quot;}}</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">partition_key_attribute</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serialize_att</span><span class="p">(</span><span class="n">partition_key_value</span><span class="p">)</span>
        <span class="n">partition_key</span><span class="p">:</span> <span class="n">PartitionKeyItem</span> <span class="o">=</span> <span class="p">{</span><span class="n">partition_key_key</span><span class="p">:</span> <span class="n">partition_key_attribute</span><span class="p">}</span>

        <span class="k">return</span> <span class="n">partition_key</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">deserialize_p_key</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">partition_key_serialized</span><span class="p">:</span> <span class="n">PartitionKeyItem</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">PartitionKeyValue</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deserialize a serialized DynamoDB partition key.</span>

<span class="sd">        :param partition_key_serialized: The serialized partition key.</span>
<span class="sd">            For example, {&quot;id&quot;: {&quot;S&quot;: &quot;string&quot;}}.</span>
<span class="sd">        :return: A tuple containing the partition key and its value.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">partition_key_key</span><span class="p">,</span> <span class="n">partition_key_value_serialized</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
            <span class="nb">iter</span><span class="p">(</span><span class="n">partition_key_serialized</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="p">)</span>
        <span class="n">partition_key_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deserialize_att</span><span class="p">(</span><span class="n">partition_key_value_serialized</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">partition_key_value</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">partition_key_key</span><span class="p">,</span> <span class="n">partition_key_value</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">serialize_put_items</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">items</span><span class="p">:</span> <span class="n">AttributeValue</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Item</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a dictionary of additional items with keys and values</span>
<span class="sd">        serialized for DynamoDB put_item call.</span>

<span class="sd">        :param items: Key-value pairs to serialize.</span>
<span class="sd">        :return: Items ready for put_item.</span>
<span class="sd">            i.e. {&quot;col1&quot;: {&quot;S&quot;: &quot;value1&quot;}, &quot;col2&quot;: {&quot;S&quot;: &quot;value2&quot;},</span>
<span class="sd">            &quot;col3&quot;: {&quot;S&quot;: &quot;value3&quot;}, ...}</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">additional_items</span><span class="p">:</span> <span class="n">Item</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">items</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">normalized_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">string_utils</span><span class="o">.</span><span class="n">snake_case</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">dynamodb_attribute</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serialize_att</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

            <span class="c1"># Now add it to the additional_items serialized dictionary</span>
            <span class="n">additional_items</span><span class="p">[</span><span class="n">normalized_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">dynamodb_attribute</span>

        <span class="k">return</span> <span class="n">additional_items</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">serialize_update_items</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">items</span><span class="p">:</span> <span class="n">AttributeValue</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">Item</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a tuple containing the UpdateExpression and the</span>
<span class="sd">        ExpressionAttributeValues ready to be passed to the DynamoDB</span>
<span class="sd">        update_item call.</span>

<span class="sd">        :param items: Key-value pairs to serialize.</span>
<span class="sd">        :return: A tuple with UpdateExpression, ExpressionAttributeNames</span>
<span class="sd">            and ExpressionAttributeValues.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">update_expression</span> <span class="o">=</span> <span class="s2">&quot;SET &quot;</span>

        <span class="c1"># In DynamoDB operations(such as UpdateItem, Query, or Scan),</span>
        <span class="c1"># you can use ExpressionAttributeNames to provide alternate</span>
        <span class="c1"># names for attributes in your expressions.This is most</span>
        <span class="c1"># commonly used to work around DynamoDB&#39;s reserved keywords or</span>
        <span class="c1"># to use attribute names that contain special characters not</span>
        <span class="c1"># allowed in expressions.</span>
        <span class="n">expression_attribute_names</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># In DynamoDB API, the ExpressionAttributeValues dictionary is</span>
        <span class="c1"># used to pass in placeholders for values that will be used in</span>
        <span class="c1"># your UpdateExpression and ConditionExpression. The keys for</span>
        <span class="c1"># these placeholders should start with a : and should not be</span>
        <span class="c1"># confused with actual column names.</span>
        <span class="n">expression_attribute_values</span><span class="p">:</span> <span class="n">Item</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">items</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">normalized_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">string_utils</span><span class="o">.</span><span class="n">snake_case</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">dynamodb_attribute</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serialize_att</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

            <span class="c1"># Add to the update_expression string</span>
            <span class="n">update_expression</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;#</span><span class="si">{</span><span class="n">normalized_key</span><span class="si">}</span><span class="s2"> = :</span><span class="si">{</span><span class="n">normalized_key</span><span class="si">}</span><span class="s2">_placeholder, &quot;</span>

            <span class="c1"># Add to the expression_attribute_names dict</span>
            <span class="n">expression_attribute_names</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;#</span><span class="si">{</span><span class="n">normalized_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">normalized_key</span>

            <span class="c1"># Add to the expression_attribute_values serialized dict</span>
            <span class="n">expression_attribute_values</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;:</span><span class="si">{</span><span class="n">normalized_key</span><span class="si">}</span><span class="s2">_placeholder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dynamodb_attribute</span>

        <span class="c1"># Removing the trailing &quot;, &quot; from the update_expression string</span>
        <span class="n">update_expression</span> <span class="o">=</span> <span class="n">update_expression</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">update_expression</span><span class="p">,</span> <span class="n">expression_attribute_names</span><span class="p">,</span> <span class="n">expression_attribute_values</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">normalize_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">AttributeValueDeserialized</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Serialize a Python item to DynamoDB format and then deserialize</span>
<span class="sd">        it back to ensure a fully consistent DynamoDB-deserialized</span>
<span class="sd">        structure.</span>

<span class="sd">        :param item: A dict of Python data, possibly partially</span>
<span class="sd">            deserialized or in raw Python format.</span>
<span class="sd">        :return: A dict representing the item in full</span>
<span class="sd">            DynamoDB-deserialized format</span>
<span class="sd">            (i.e., matching AttributeValueDeserialized).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">item_serialized</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">serialize_att</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="n">item_deserialized</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">key</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">deserialize_att</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">item_serialized</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">item_deserialized</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">CarlogttPythonLibrary</a></h1>










<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../_apidoc/modules.html">src</a></li>
</ul>


<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>










        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2025, Carlo Gatti.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>
