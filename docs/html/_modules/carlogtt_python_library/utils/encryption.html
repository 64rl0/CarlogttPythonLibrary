<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>carlogtt_python_library.utils.encryption &#8212; CarlogttPythonLibrary r. documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="../../../_static/basic.css?v=9d6d948b" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css?v=772fa434" />
    <script src="../../../_static/documentation_options.js?v=30015795"></script>
    <script src="../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for carlogtt_python_library.utils.encryption</h1><div class="highlight"><pre>
<span></span><span class="c1"># ======================================================================</span>
<span class="c1"># MODULE DETAILS</span>
<span class="c1"># This section provides metadata about the module, including its</span>
<span class="c1"># creation date, author, copyright information, and a brief description</span>
<span class="c1"># of the module&#39;s purpose and functionality.</span>
<span class="c1"># ======================================================================</span>

<span class="c1">#   __|    \    _ \  |      _ \   __| __ __| __ __|</span>
<span class="c1">#  (      _ \     /  |     (   | (_ |    |      |</span>
<span class="c1"># \___| _/  _\ _|_\ ____| \___/ \___|   _|     _|</span>

<span class="c1"># src/carlogtt_library/utils/encryption.py</span>
<span class="c1"># Created 10/2/23 - 9:25 AM UK Time (London) by carlogtt</span>
<span class="c1"># Copyright (c) Amazon.com Inc. All Rights Reserved.</span>
<span class="c1"># AMAZON.COM CONFIDENTIAL</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module provides functions and utilities for password encryption.</span>
<span class="sd">It offers encryption algorithms and techniques specifically designed for</span>
<span class="sd">securely storing and handling passwords.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># ======================================================================</span>
<span class="c1"># EXCEPTIONS</span>
<span class="c1"># This section documents any exceptions made or code quality rules.</span>
<span class="c1"># These exceptions may be necessary due to specific coding requirements</span>
<span class="c1"># or to bypass false positives.</span>
<span class="c1"># ======================================================================</span>
<span class="c1">#</span>

<span class="c1"># ======================================================================</span>
<span class="c1"># IMPORTS</span>
<span class="c1"># Importing required libraries and modules for the application.</span>
<span class="c1"># ======================================================================</span>

<span class="c1"># Standard Library Imports</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ast</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">base64</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">enum</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">string</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections.abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">Sequence</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Union</span>

<span class="c1"># Third Party Library Imports</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cryptography.fernet</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cryptography.hazmat.primitives.ciphers.algorithms</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cryptography.hazmat.primitives.ciphers.modes</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cryptography.hazmat.primitives.hashes</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cryptography.hazmat.primitives.hmac</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cryptography.hazmat.primitives.kdf.hkdf</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cryptography.hazmat.primitives.kdf.scrypt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cryptography.hazmat.primitives.padding</span>

<span class="c1"># Local Folder (Relative) Imports</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..</span><span class="w"> </span><span class="kn">import</span> <span class="n">exceptions</span>

<span class="c1"># END IMPORTS</span>
<span class="c1"># ======================================================================</span>


<span class="c1"># List of public names in the module</span>
<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;KeyType&#39;</span><span class="p">,</span>
    <span class="s1">&#39;KeyOutputType&#39;</span><span class="p">,</span>
    <span class="s1">&#39;EncryptionAlgorithm&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Cryptography&#39;</span><span class="p">,</span>
<span class="p">]</span>

<span class="c1"># Setting up logger for current module</span>
<span class="n">module_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># Type aliases</span>
<span class="c1">#</span>


<div class="viewcode-block" id="KeyType">
<a class="viewcode-back" href="../../../_apidoc/carlogtt_python_library.utils.encryption.html#carlogtt_python_library.utils.encryption.KeyType">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">KeyType</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Enumeration to specify the key type based on its length.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        AES128: Represents a key length of 128 bits (16 bytes) for AES</span>
<span class="sd">                encryption. This size is often used for its balance</span>
<span class="sd">                between security and performance.</span>
<span class="sd">        AES256: Represents a key length of 256 bits (32 bytes) for AES</span>
<span class="sd">                encryption. Offers a high level of security and is</span>
<span class="sd">                recommended for situations requiring enhanced data</span>
<span class="sd">                protection.</span>
<span class="sd">        INITIALIZATION_VECTOR: A 128-bit (16-byte) IV used in various</span>
<span class="sd">                               encryption modes to ensure ciphertext</span>
<span class="sd">                               uniqueness. Suitable for use with AES</span>
<span class="sd">                               and other block ciphers in modes like</span>
<span class="sd">                               CBC.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">AES128</span> <span class="o">=</span> <span class="mi">16</span>
    <span class="n">AES256</span> <span class="o">=</span> <span class="mi">32</span>
    <span class="n">INITIALIZATION_VECTOR</span> <span class="o">=</span> <span class="mi">16</span></div>



<div class="viewcode-block" id="KeyOutputType">
<a class="viewcode-back" href="../../../_apidoc/carlogtt_python_library.utils.encryption.html#carlogtt_python_library.utils.encryption.KeyOutputType">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">KeyOutputType</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Enumeration to specify the output format of the generated key.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        BYTES: The key is returned as raw bytes.</span>
<span class="sd">        BASE64: The key is returned as URL-safe Base64-encoded bytes.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">BYTES</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">BASE64</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span></div>



<div class="viewcode-block" id="EncryptionAlgorithm">
<a class="viewcode-back" href="../../../_apidoc/carlogtt_python_library.utils.encryption.html#carlogtt_python_library.utils.encryption.EncryptionAlgorithm">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">EncryptionAlgorithm</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Defines supported encryption algorithms and their corresponding</span>
<span class="sd">    security levels.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">AES_128</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">AES_256</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span></div>



<div class="viewcode-block" id="Cryptography">
<a class="viewcode-back" href="../../../_apidoc/carlogtt_python_library.utils.encryption.html#carlogtt_python_library.utils.encryption.Cryptography">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Cryptography</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Provides cryptographic functionalities including key generation,</span>
<span class="sd">    serialization for storage, encryption, decryption, and signing.</span>
<span class="sd">    Utilizes symmetric encryption (AES-256) and HMAC for signing.</span>

<span class="sd">    :param logger: The logging.Logger instance to be used for logging</span>
<span class="sd">           the execution time of the decorated function.</span>
<span class="sd">           If not explicitly provided, the function uses</span>
<span class="sd">           Python&#39;s standard logging module as a default logger.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logger</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span> <span class="o">=</span> <span class="n">module_logger</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>

<div class="viewcode-block" id="Cryptography.create_key">
<a class="viewcode-back" href="../../../_apidoc/carlogtt_python_library.utils.encryption.html#carlogtt_python_library.utils.encryption.Cryptography.create_key">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key_type</span><span class="p">:</span> <span class="n">KeyType</span><span class="p">,</span> <span class="n">key_output</span><span class="p">:</span> <span class="n">KeyOutputType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates a cryptographic key of specified type and returns it</span>
<span class="sd">        in the specified output format.</span>

<span class="sd">        :param key_type: The type of key to generate, affecting its</span>
<span class="sd">               length.</span>
<span class="sd">        :param key_output: The output format of the generated key.</span>
<span class="sd">        :returns: The generated key in the specified output format.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key_type</span><span class="p">,</span> <span class="n">KeyType</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">CryptographyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid key type: </span><span class="si">{</span><span class="n">key_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Create a random bytes</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="n">key_type</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

        <span class="c1"># Return the key based on the output format</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key_type</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">-Bytes Key for </span><span class="si">{</span><span class="n">key_type</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">key_output</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> created&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">key_output</span> <span class="ow">is</span> <span class="n">KeyOutputType</span><span class="o">.</span><span class="n">BYTES</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">key</span>

        <span class="k">elif</span> <span class="n">key_output</span> <span class="ow">is</span> <span class="n">KeyOutputType</span><span class="o">.</span><span class="n">BASE64</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64encode</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">CryptographyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid key output type: </span><span class="si">{</span><span class="n">key_output</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Cryptography.serialize_key_for_str_storage">
<a class="viewcode-back" href="../../../_apidoc/carlogtt_python_library.utils.encryption.html#carlogtt_python_library.utils.encryption.Cryptography.serialize_key_for_str_storage">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">serialize_key_for_str_storage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts a bytes object (key) to a string representation</span>
<span class="sd">        suitable for storage. Utilizes Python&#39;s repr() function to</span>
<span class="sd">        create a string that represents the bytes object.</span>

<span class="sd">        :param key: The bytes object to be serialized.</span>
<span class="sd">        :return: A string representation of the bytes object, including</span>
<span class="sd">                 the bytes literal prefix b&#39;&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Serializing key for storage&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="n">key</span><span class="p">)</span></div>


<div class="viewcode-block" id="Cryptography.deserialize_key_from_str_storage">
<a class="viewcode-back" href="../../../_apidoc/carlogtt_python_library.utils.encryption.html#carlogtt_python_library.utils.encryption.Cryptography.deserialize_key_from_str_storage">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">deserialize_key_from_str_storage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts a string representation of a bytes object back into the</span>
<span class="sd">        original bytes object. This function is intended to be used in</span>
<span class="sd">        conjunction with serialize_key_for_str_storage, allowing for the</span>
<span class="sd">        retrieval of the original bytes object from a stored string.</span>

<span class="sd">        :param key: The string representation of the bytes object,</span>
<span class="sd">               expected to include the bytes literal prefix b&#39;&#39;.</span>
<span class="sd">        :return: The original bytes object.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Deserializing key from storage&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">key</span><span class="p">)</span></div>


<div class="viewcode-block" id="Cryptography.hash_string">
<a class="viewcode-back" href="../../../_apidoc/carlogtt_python_library.utils.encryption.html#carlogtt_python_library.utils.encryption.Cryptography.hash_string">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">hash_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Hashes a given string using the Scrypt Key Derivation Function</span>
<span class="sd">        and encrypts the result for secure storage.</span>
<span class="sd">        The function embeds the salt used for hashing within the</span>
<span class="sd">        encrypted hash, ensuring that each piece of data is uniquely</span>
<span class="sd">        salted and securely stored.</span>

<span class="sd">        :param raw_string: The raw string to be hashed and encrypted.</span>
<span class="sd">               Typically, this would be a password or any other</span>
<span class="sd">               sensitive information requiring secure handling.</span>
<span class="sd">        :param key: The secret key used for encrypting the hashed</span>
<span class="sd">               string. This key should be generated and managed using</span>
<span class="sd">               secure cryptographic practices and must be a 32-byte key</span>
<span class="sd">               for AES-256.</span>
<span class="sd">        :return: The encrypted hash of the input string.</span>
<span class="sd">                 This output includes both the Scrypt-derived</span>
<span class="sd">                 hash and the salt, encrypted for additional security.</span>
<span class="sd">                 The resulting binary data is suitable for secure</span>
<span class="sd">                 storage in a database or file system, where it can</span>
<span class="sd">                 later be decrypted and verified against a user-provided</span>
<span class="sd">                 string.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Encode raw_password to bytes</span>
        <span class="n">b_raw_string</span> <span class="o">=</span> <span class="n">raw_string</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>

        <span class="c1"># Generate a random salt for the password encryption</span>
        <span class="n">salt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_key</span><span class="p">(</span><span class="n">KeyType</span><span class="o">.</span><span class="n">AES128</span><span class="p">,</span> <span class="n">KeyOutputType</span><span class="o">.</span><span class="n">BYTES</span><span class="p">)</span>
        <span class="c1"># Encode the salt to url-safe byte array</span>
        <span class="n">salt_base64</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64encode</span><span class="p">(</span><span class="n">salt</span><span class="p">)</span>

        <span class="c1"># Derive key using Scrypt</span>
        <span class="n">b_hashed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_derive_key_scrypt</span><span class="p">(</span><span class="n">salt</span><span class="p">,</span> <span class="n">b_raw_string</span><span class="p">)</span>

        <span class="c1"># Encode derived_key to url-safe byte array</span>
        <span class="n">b_hashed_base64</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64encode</span><span class="p">(</span><span class="n">b_hashed</span><span class="p">)</span>

        <span class="c1"># Embed salt into hashed string joining them together with</span>
        <span class="c1"># byte &quot;&amp;&quot;</span>
        <span class="n">b_hashed_salt</span> <span class="o">=</span> <span class="n">b_hashed_base64</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&quot;&amp;&quot;</span> <span class="o">+</span> <span class="n">salt_base64</span>

        <span class="c1"># It&#39;s now time to encrypt it for additional security as at this</span>
        <span class="c1"># stage the string is simply urlsafe_b64encoded therefore would</span>
        <span class="c1"># be pretty straight forward for someone to decode it with</span>
        <span class="c1"># urlsafe_b64decode and find the special &quot;&amp;&quot; which separates the</span>
        <span class="c1"># hashed_string and the salt</span>

        <span class="c1"># Decode to pass to encrypt function</span>
        <span class="n">s_hashed_salt</span> <span class="o">=</span> <span class="n">b_hashed_salt</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>

        <span class="c1"># Encrypt</span>
        <span class="n">ciphertext</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encrypt_string</span><span class="p">(</span><span class="n">s_hashed_salt</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">EncryptionAlgorithm</span><span class="o">.</span><span class="n">AES_256</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ciphertext</span></div>


<div class="viewcode-block" id="Cryptography.validate_hash_match">
<a class="viewcode-back" href="../../../_apidoc/carlogtt_python_library.utils.encryption.html#carlogtt_python_library.utils.encryption.Cryptography.validate_hash_match">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_hash_match</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">raw_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">hashed_to_match</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">key</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validates whether a provided raw string matches the encrypted</span>
<span class="sd">        and hashed string stored. This function is designed to work in</span>
<span class="sd">        conjunction with hash_string function, reversing its hashing and</span>
<span class="sd">        encryption process to verify user input against stored values</span>
<span class="sd">        securely.</span>

<span class="sd">        :param raw_string: The plaintext string provided by the user,</span>
<span class="sd">               typically a password or sensitive information that needs</span>
<span class="sd">               validation against a stored, hashed version.</span>
<span class="sd">        :param hashed_to_match: The encrypted and hashed data that the</span>
<span class="sd">               raw_string is compared against. This should have been</span>
<span class="sd">               previously generated by the hash_string function.</span>
<span class="sd">        :param key: The secret key used for decrypting the hashed</span>
<span class="sd">               string. It must be the same key used for</span>
<span class="sd">               encrypting the string initially with the `hash_string`</span>
<span class="sd">               function.</span>
<span class="sd">        :return: True if the raw_string, when hashed and processed,</span>
<span class="sd">                 matches the hashed_string_to_match; False otherwise.</span>
<span class="sd">                 The function also returns False in the case of</span>
<span class="sd">                 decryption or verification failures.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">raw_string</span> <span class="ow">and</span> <span class="n">hashed_to_match</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Decrypt</span>
            <span class="n">s_hashed_salt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decrypt_string</span><span class="p">(</span><span class="n">hashed_to_match</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">EncryptionAlgorithm</span><span class="o">.</span><span class="n">AES_256</span><span class="p">)</span>

            <span class="c1"># Encode</span>
            <span class="n">b_hashed_salt</span> <span class="o">=</span> <span class="n">s_hashed_salt</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>

            <span class="c1"># Split</span>
            <span class="c1"># b_hashed_string_url_safe_clean and salt_url_safe_clean</span>
            <span class="n">b_hashed_base64</span><span class="p">,</span> <span class="n">salt_base64</span> <span class="o">=</span> <span class="n">b_hashed_salt</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;&amp;&quot;</span><span class="p">)</span>

            <span class="c1"># Retrieve original salt and original b_hashed_string by</span>
            <span class="c1"># decoding urlsafe_b64decode</span>
            <span class="n">b_hashed</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64decode</span><span class="p">(</span><span class="n">b_hashed_base64</span><span class="p">)</span>
            <span class="n">salt</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64decode</span><span class="p">(</span><span class="n">salt_base64</span><span class="p">)</span>

            <span class="c1"># Now we are ready to compare with the string to validate,</span>
            <span class="c1"># we need to convert the raw string to bytes</span>
            <span class="n">b_raw_string</span> <span class="o">=</span> <span class="n">raw_string</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>

            <span class="c1"># Verify derived key using Scrypt</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_verify_derived_key_scrypt</span><span class="p">(</span><span class="n">salt</span><span class="p">,</span> <span class="n">b_raw_string</span><span class="p">,</span> <span class="n">b_hashed</span><span class="p">)</span>

            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Hash validation failed w/ error: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="Cryptography.sign">
<a class="viewcode-back" href="../../../_apidoc/carlogtt_python_library.utils.encryption.html#carlogtt_python_library.utils.encryption.Cryptography.sign">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">sign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_to_sign</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Signs the given data using HMAC with SHA256 hash function.</span>

<span class="sd">        First, the data is encoded to Base64. Then, an HMAC signature is</span>
<span class="sd">        generated using the provided key and the SHA256 hash function.</span>
<span class="sd">        The data and its HMAC signature are concatenated, base64</span>
<span class="sd">        encoded, and returned.</span>

<span class="sd">        :param data_to_sign: Data to be signed.</span>
<span class="sd">        :param key: Secret key used for HMAC.</span>
<span class="sd">        :returns: Base64 encoded signature of the data.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Encode the data_to_sign to Base64</span>
        <span class="n">data_to_sign_base64</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64encode</span><span class="p">(</span><span class="n">data_to_sign</span><span class="p">)</span>

        <span class="c1"># Create Hash-based message authentication codes (HMAC)</span>
        <span class="n">hmac_hash</span> <span class="o">=</span> <span class="n">cryptography</span><span class="o">.</span><span class="n">hazmat</span><span class="o">.</span><span class="n">primitives</span><span class="o">.</span><span class="n">hmac</span><span class="o">.</span><span class="n">HMAC</span><span class="p">(</span>
            <span class="n">key</span><span class="p">,</span> <span class="n">cryptography</span><span class="o">.</span><span class="n">hazmat</span><span class="o">.</span><span class="n">primitives</span><span class="o">.</span><span class="n">hashes</span><span class="o">.</span><span class="n">SHA256</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="c1"># Hash the data to create the signature</span>
        <span class="n">hmac_hash</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data_to_sign</span><span class="p">)</span>
        <span class="n">hash_signature</span> <span class="o">=</span> <span class="n">hmac_hash</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>
        <span class="n">hash_signature_base64</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64encode</span><span class="p">(</span><span class="n">hash_signature</span><span class="p">)</span>

        <span class="c1"># The Hashing Signature need to be stored with the data</span>
        <span class="n">data_and_hash_signature</span> <span class="o">=</span> <span class="n">data_to_sign_base64</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&quot;&amp;&quot;</span> <span class="o">+</span> <span class="n">hash_signature_base64</span>

        <span class="c1"># Base64 encode the data and the signature</span>
        <span class="n">signature</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64encode</span><span class="p">(</span><span class="n">data_and_hash_signature</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Data signed successfully&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">signature</span></div>


<div class="viewcode-block" id="Cryptography.verify_signature">
<a class="viewcode-back" href="../../../_apidoc/carlogtt_python_library.utils.encryption.html#carlogtt_python_library.utils.encryption.Cryptography.verify_signature">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">verify_signature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signature</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verifies the signature of the provided data.</span>

<span class="sd">        Decodes the signature from Base64, extracts the data and its</span>
<span class="sd">        HMAC signature, and verifies it using HMAC with SHA256. Returns</span>
<span class="sd">        a dict indicating whether the signature is valid, the original</span>
<span class="sd">        data, and the hash signature.</span>

<span class="sd">        :param signature: Base64 encoded data and signature.</span>
<span class="sd">        :param key: Secret key used for HMAC verification.</span>
<span class="sd">        :return: A dictionary containing the verification result, the</span>
<span class="sd">                 original data, and the hash signature with the keys</span>
<span class="sd">                 &#39;data&#39;, &#39;signature&#39;, &#39;signature_valid&#39;, and possibly</span>
<span class="sd">                 &#39;response_info&#39; if an error occurs.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">response</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s1">&#39;signature&#39;</span><span class="p">:</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s1">&#39;signature_valid&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Decode the Base64 encoded data</span>
            <span class="n">data_and_hash_signature</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64decode</span><span class="p">(</span><span class="n">signature</span><span class="p">)</span>

            <span class="c1"># Extract the data_to_sign_base64 and the</span>
            <span class="c1"># hash_signature_base64</span>
            <span class="n">data_base64</span><span class="p">,</span> <span class="n">hash_signature_base64</span> <span class="o">=</span> <span class="n">data_and_hash_signature</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;&amp;&quot;</span><span class="p">)</span>

            <span class="c1"># Decode the Base64</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64decode</span><span class="p">(</span><span class="n">data_base64</span><span class="p">)</span>
            <span class="n">hash_signature</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64decode</span><span class="p">(</span><span class="n">hash_signature_base64</span><span class="p">)</span>

            <span class="c1"># Update return dict with data and hash_signature</span>
            <span class="n">response</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">signature</span><span class="o">=</span><span class="n">hash_signature</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="c1"># Update the return dict with failed validation</span>
            <span class="n">response</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">response_info</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">response</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Create Hash-based message authentication codes (HMAC)</span>
            <span class="n">hmac_hash</span> <span class="o">=</span> <span class="n">cryptography</span><span class="o">.</span><span class="n">hazmat</span><span class="o">.</span><span class="n">primitives</span><span class="o">.</span><span class="n">hmac</span><span class="o">.</span><span class="n">HMAC</span><span class="p">(</span>
                <span class="n">key</span><span class="p">,</span> <span class="n">cryptography</span><span class="o">.</span><span class="n">hazmat</span><span class="o">.</span><span class="n">primitives</span><span class="o">.</span><span class="n">hashes</span><span class="o">.</span><span class="n">SHA256</span><span class="p">()</span>
            <span class="p">)</span>

            <span class="c1"># Validate the Signature</span>
            <span class="n">hmac_hash</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">hmac_hash</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">hash_signature</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Signature verified successfully&quot;</span><span class="p">)</span>

            <span class="c1"># Update the return dict with successful validation</span>
            <span class="n">response</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">signature_valid</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">response</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Signature verification failed w/ error: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Update the return dict with failed validation</span>
            <span class="n">response</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">response_info</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span>

            <span class="k">return</span> <span class="n">response</span></div>


<div class="viewcode-block" id="Cryptography.encrypt_string">
<a class="viewcode-back" href="../../../_apidoc/carlogtt_python_library.utils.encryption.html#carlogtt_python_library.utils.encryption.Cryptography.encrypt_string">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">encrypt_string</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">plaintext</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">key</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span>
        <span class="n">algorithm</span><span class="p">:</span> <span class="n">EncryptionAlgorithm</span> <span class="o">=</span> <span class="n">EncryptionAlgorithm</span><span class="o">.</span><span class="n">AES_256</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Encrypts a string using the specified symmetric encryption</span>
<span class="sd">        algorithm.</span>

<span class="sd">        This function provides a unified interface to encrypt strings</span>
<span class="sd">        using different encryption algorithms specified by the</span>
<span class="sd">        &#39;algorithm&#39; parameter. It delegates the encryption process to</span>
<span class="sd">        the appropriate internal function based on the chosen algorithm.</span>

<span class="sd">        :param plaintext: The plaintext string to be encrypted.</span>
<span class="sd">        :param key: The secret key used for encryption. The format and</span>
<span class="sd">               length depend on the algorithm being used.</span>
<span class="sd">               For AES-128, must be a URL-safe base64-encoded 32-byte</span>
<span class="sd">               key. For AES-256, must be a 32-byte key.</span>
<span class="sd">        :param algorithm: An instance of the</span>
<span class="sd">               EncryptionEncryptionAlgorithm enum indicating the</span>
<span class="sd">               encryption algorithm to use.</span>
<span class="sd">               Default EncryptionAlgorithm.AES_256</span>
<span class="sd">        :return: The encrypted string, encoded with Base64 to ensure the</span>
<span class="sd">                 encrypted data is text-safe. With padding removed for</span>
<span class="sd">                 storage efficiency.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">algorithm</span> <span class="ow">is</span> <span class="n">EncryptionAlgorithm</span><span class="o">.</span><span class="n">AES_128</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_encrypt_aes128</span><span class="p">(</span><span class="n">plaintext</span><span class="o">=</span><span class="n">plaintext</span><span class="p">,</span> <span class="n">fernet_key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">algorithm</span> <span class="ow">is</span> <span class="n">EncryptionAlgorithm</span><span class="o">.</span><span class="n">AES_256</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_encrypt_aes256</span><span class="p">(</span><span class="n">plaintext</span><span class="o">=</span><span class="n">plaintext</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;algorthm must be one of the following </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">EncryptionAlgorithm</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Cryptography.decrypt_string">
<a class="viewcode-back" href="../../../_apidoc/carlogtt_python_library.utils.encryption.html#carlogtt_python_library.utils.encryption.Cryptography.decrypt_string">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">decrypt_string</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ciphertext</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">key</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span>
        <span class="n">algorithm</span><span class="p">:</span> <span class="n">EncryptionAlgorithm</span> <span class="o">=</span> <span class="n">EncryptionAlgorithm</span><span class="o">.</span><span class="n">AES_256</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Decrypts a string previously encrypted by the `encrypt_string`</span>
<span class="sd">        function using the specified symmetric encryption algorithm.</span>

<span class="sd">        This function provides a unified interface to decrypt strings</span>
<span class="sd">        using different encryption algorithms specified by the</span>
<span class="sd">        &#39;algorithm&#39; parameter. It delegates the decryption process to</span>
<span class="sd">        the appropriate internal function based on the chosen algorithm.</span>

<span class="sd">        :param ciphertext: The encrypted string to be decrypted.</span>
<span class="sd">               It is expected to be Base64 encoded and without padding.</span>
<span class="sd">        :param key: The secret key used for decryption. Must match the</span>
<span class="sd">               key used for encryption and be appropriate for the</span>
<span class="sd">               specified algorithm.</span>
<span class="sd">        :param algorithm: An instance of the EncryptionAlgorithm enum</span>
<span class="sd">               indicating the encryption algorithm to use.</span>
<span class="sd">               Default EncryptionAlgorithm.AES_256</span>
<span class="sd">        :return: The decrypted plaintext string. Returns an empty string</span>
<span class="sd">                 and logs a warning if decryption fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">algorithm</span> <span class="ow">is</span> <span class="n">EncryptionAlgorithm</span><span class="o">.</span><span class="n">AES_128</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decrypt_aes128</span><span class="p">(</span><span class="n">ciphertext</span><span class="o">=</span><span class="n">ciphertext</span><span class="p">,</span> <span class="n">fernet_key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">algorithm</span> <span class="ow">is</span> <span class="n">EncryptionAlgorithm</span><span class="o">.</span><span class="n">AES_256</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decrypt_aes256</span><span class="p">(</span><span class="n">ciphertext</span><span class="o">=</span><span class="n">ciphertext</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;algorthm must be one of the following </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">EncryptionAlgorithm</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Cryptography.re_encrypt_string">
<a class="viewcode-back" href="../../../_apidoc/carlogtt_python_library.utils.encryption.html#carlogtt_python_library.utils.encryption.Cryptography.re_encrypt_string">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">re_encrypt_string</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ciphertext_to_re_encrypt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">old_key</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span>
        <span class="n">new_key</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span>
        <span class="n">old_algorithm</span><span class="p">:</span> <span class="n">EncryptionAlgorithm</span> <span class="o">=</span> <span class="n">EncryptionAlgorithm</span><span class="o">.</span><span class="n">AES_256</span><span class="p">,</span>
        <span class="n">new_algorithm</span><span class="p">:</span> <span class="n">EncryptionAlgorithm</span> <span class="o">=</span> <span class="n">EncryptionAlgorithm</span><span class="o">.</span><span class="n">AES_256</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Re-encrypts data, transitioning it from an old key to a new key.</span>

<span class="sd">        This function first decrypts the given encrypted data with the</span>
<span class="sd">        old key, then re-encrypts it using the new key. It supports key</span>
<span class="sd">        rotation and the update of the encryption scheme for securely</span>
<span class="sd">        stored data.</span>

<span class="sd">        Ideal for key rotation or encryption scheme updates, ensuring</span>
<span class="sd">        data remains secure during key transitions or algorithm updates.</span>

<span class="sd">        :param ciphertext_to_re_encrypt: Encrypted data with old key.</span>
<span class="sd">        :param old_key: The old encryption key.</span>
<span class="sd">        :param new_key: The new encryption key for re-encryption.</span>
<span class="sd">        :param old_algorithm: An instance of the EncryptionAlgorithm</span>
<span class="sd">               enum indicating the encryption algorithm to use.</span>
<span class="sd">               Default EncryptionAlgorithm.AES_256</span>
<span class="sd">        :param new_algorithm: An instance of the EncryptionAlgorithm</span>
<span class="sd">               enum indicating the encryption algorithm to use.</span>
<span class="sd">               Default EncryptionAlgorithm.AES_256</span>
<span class="sd">        :return: Re-encrypted data as a string with the new key.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Decrypt data with old key</span>
        <span class="n">plaintext</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decrypt_string</span><span class="p">(</span>
            <span class="n">ciphertext_to_re_encrypt</span><span class="p">,</span>
            <span class="n">old_key</span><span class="p">,</span>
            <span class="n">old_algorithm</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Encrypt the data with the new key</span>
        <span class="n">ciphertext_re_encrypted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encrypt_string</span><span class="p">(</span>
            <span class="n">plaintext</span><span class="p">,</span>
            <span class="n">new_key</span><span class="p">,</span>
            <span class="n">new_algorithm</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">ciphertext_re_encrypted</span></div>


<div class="viewcode-block" id="Cryptography.create_token">
<a class="viewcode-back" href="../../../_apidoc/carlogtt_python_library.utils.encryption.html#carlogtt_python_library.utils.encryption.Cryptography.create_token">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_token</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">length</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">validity_secs</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">population</span><span class="p">:</span> <span class="n">Sequence</span> <span class="o">=</span> <span class="p">()</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates a secure token and its expiry time. The token is</span>
<span class="sd">        encrypted with a given key to produce a cipher token.</span>

<span class="sd">        :param length: Length of the random token</span>
<span class="sd">               maximum is 62 characters.</span>
<span class="sd">        :param validity_secs: Time in seconds until the token expires.</span>
<span class="sd">        :param key: The secret key used for encryption.</span>
<span class="sd">               Must be a 32-byte key for AES-256.</span>
<span class="sd">        :param population: Lets you define a different set of characters</span>
<span class="sd">               that the token can be composed of.</span>
<span class="sd">               Default letters and digits</span>
<span class="sd">        :raise ValueError: If length is greater than 62.</span>
<span class="sd">        :return: A dictionary with &#39;token&#39;, &#39;expiry&#39;, and &#39;ciphertoken&#39;</span>
<span class="sd">                 keys.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">length</span> <span class="o">&gt;</span> <span class="mi">62</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;length cannot be greater than 62&quot;</span><span class="p">)</span>

        <span class="n">population</span> <span class="o">=</span> <span class="n">population</span> <span class="ow">or</span> <span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span>

        <span class="n">random_string</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">population</span><span class="p">,</span> <span class="n">length</span><span class="p">))</span>
        <span class="n">random_string_hashed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash_string</span><span class="p">(</span><span class="n">random_string</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="n">random_string_hashed_base64</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64encode</span><span class="p">(</span><span class="n">random_string_hashed</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>

        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time_ns</span><span class="p">()</span>
        <span class="n">expires</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="n">validity_secs</span> <span class="o">*</span> <span class="mi">1_000_000_000</span>
        <span class="n">expires_base64</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64encode</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">expires</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>

        <span class="n">combined</span> <span class="o">=</span> <span class="n">random_string_hashed_base64</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&quot;&amp;&quot;</span> <span class="o">+</span> <span class="n">expires_base64</span>

        <span class="n">combined_encrypted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encrypt_string</span><span class="p">(</span><span class="n">combined</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span> <span class="n">key</span><span class="p">)</span>

        <span class="n">response</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;token&#39;</span><span class="p">:</span> <span class="n">random_string</span><span class="p">,</span>
            <span class="s1">&#39;expiry&#39;</span><span class="p">:</span> <span class="n">expires</span><span class="p">,</span>
            <span class="s1">&#39;ciphertoken&#39;</span><span class="p">:</span> <span class="n">combined_encrypted</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">response</span></div>


<div class="viewcode-block" id="Cryptography.verify_token">
<a class="viewcode-back" href="../../../_apidoc/carlogtt_python_library.utils.encryption.html#carlogtt_python_library.utils.encryption.Cryptography.verify_token">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">verify_token</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ciphertoken</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">bytes</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verifies the validity of the given token by decrypting the</span>
<span class="sd">        cipher token using the provided key, and checks if it&#39;s expired</span>
<span class="sd">        based on the current time and the expiry time embedded in the</span>
<span class="sd">        cipher token.</span>

<span class="sd">        :param token: The original token to be validated.</span>
<span class="sd">        :param ciphertoken: The encrypted string containing the token</span>
<span class="sd">               and expiry.</span>
<span class="sd">        :param key: The secret key used for encryption.</span>
<span class="sd">               Must be a 32-byte key for AES-256.</span>
<span class="sd">        :return: A dictionary with the keys &#39;token_valid&#39;, &#39;token&#39;,</span>
<span class="sd">                 &#39;expiry&#39;, and possibly &#39;response_info&#39; if an error</span>
<span class="sd">                 occurs.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Initializing code validity response and override if True</span>
        <span class="n">response</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;token_valid&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;token&#39;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s1">&#39;expiry&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">combined</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decrypt_string</span><span class="p">(</span><span class="n">ciphertoken</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">random_string_hashed_base64</span><span class="p">,</span> <span class="n">expiry_base64</span> <span class="o">=</span> <span class="n">combined</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;&amp;&quot;</span><span class="p">)</span>
            <span class="n">random_string_hashed</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64decode</span><span class="p">(</span><span class="n">random_string_hashed_base64</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>

            <span class="n">expiry</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64decode</span><span class="p">(</span><span class="n">expiry_base64</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time_ns</span><span class="p">()</span>

            <span class="n">response</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">,</span> <span class="n">expiry</span><span class="o">=</span><span class="n">expiry</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">response</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">response_info</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">response</span>

        <span class="k">if</span> <span class="n">now</span> <span class="o">&lt;</span> <span class="n">expiry</span><span class="p">:</span>
            <span class="n">confirmation_code_valid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_hash_match</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">random_string_hashed</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="n">response</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">token_valid</span><span class="o">=</span><span class="n">confirmation_code_valid</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">response</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">response_info</span><span class="o">=</span><span class="s2">&quot;Token expired&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">response</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_encrypt_aes128</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plaintext</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">fernet_key</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Encrypts a string using Fernet symmetric encryption.</span>

<span class="sd">        This function encrypts a given string with Fernet, encoding the</span>
<span class="sd">        input to bytes, then encrypting. It removes the padding (&quot;=&quot;) at</span>
<span class="sd">        the end of the encrypted byte array to minimize storage.</span>

<span class="sd">        :param plaintext: The plaintext string to be encrypted.</span>
<span class="sd">        :param fernet_key: The secret key used for encryption. Must be a</span>
<span class="sd">               URL-safe base64-encoded 32-byte key.</span>
<span class="sd">        :return: The encrypted string, encoded with Base64 to ensure the</span>
<span class="sd">                 encrypted data is text-safe. With padding removed for</span>
<span class="sd">                 storage efficiency.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Ensure the Fernet key length is valid</span>
        <span class="c1"># For a bytes_length of 32, the length of the Base64-encoded</span>
        <span class="c1"># string without stripping padding would be 44 characters.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fernet_key</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">44</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Fernet key must be a URL-safe base64-encoded 32-byte key.&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">cipher_suite</span> <span class="o">=</span> <span class="n">cryptography</span><span class="o">.</span><span class="n">fernet</span><span class="o">.</span><span class="n">Fernet</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">fernet_key</span><span class="p">)</span>

        <span class="n">b_string_to_encrypt</span> <span class="o">=</span> <span class="n">plaintext</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
        <span class="n">b_encrypted</span> <span class="o">=</span> <span class="n">cipher_suite</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">b_string_to_encrypt</span><span class="p">)</span>

        <span class="c1"># Strip last two &quot;==&quot; at the end as Fernet always return a 64</span>
        <span class="c1"># bytes array which ends with two &quot;==&quot;</span>
        <span class="n">b_encrypted_clean</span> <span class="o">=</span> <span class="n">b_encrypted</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;=&quot;</span><span class="p">)</span>

        <span class="n">s_encrypted_clean</span> <span class="o">=</span> <span class="n">b_encrypted_clean</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">s_encrypted_clean</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_decrypt_aes128</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ciphertext</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">fernet_key</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Decrypts a string previously encrypted by _encrypt_string_aes128</span>

<span class="sd">        Attempts to decrypt the provided string using the given Fernet</span>
<span class="sd">        key. If decryption fails, it catches the exception, logs a</span>
<span class="sd">        warning, and returns an empty string to indicate failure.</span>

<span class="sd">        :param ciphertext: The encrypted string to be decrypted.</span>
<span class="sd">               Padding will be re-added internally for decryption.</span>
<span class="sd">        :param fernet_key: The secret key used for decryption.</span>
<span class="sd">               Must match the key used for encryption.</span>
<span class="sd">        :return: The decrypted plaintext string. Returns an empty string</span>
<span class="sd">                 and logs a warning if decryption fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Ensure the Fernet key length is valid</span>
        <span class="c1"># For a bytes_length of 32, the length of the Base64-encoded</span>
        <span class="c1"># string without stripping padding would be 44 characters.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fernet_key</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">44</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Fernet key must be a URL-safe base64-encoded 32-byte key.&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Correct the Base64 padding if necessary</span>
        <span class="n">missing_padding</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ciphertext</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span>
        <span class="k">if</span> <span class="n">missing_padding</span><span class="p">:</span>
            <span class="n">ciphertext</span> <span class="o">+=</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">4</span> <span class="o">-</span> <span class="n">missing_padding</span><span class="p">)</span>

        <span class="n">cipher_suite</span> <span class="o">=</span> <span class="n">cryptography</span><span class="o">.</span><span class="n">fernet</span><span class="o">.</span><span class="n">Fernet</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">fernet_key</span><span class="p">)</span>

        <span class="n">b_encrypted</span> <span class="o">=</span> <span class="n">ciphertext</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">b_decrypted</span> <span class="o">=</span> <span class="n">cipher_suite</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">b_encrypted</span><span class="p">)</span>
            <span class="n">s_decrypted</span> <span class="o">=</span> <span class="n">b_decrypted</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>

            <span class="k">return</span> <span class="n">s_decrypted</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Decryption failed w/ error: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_encrypt_aes256</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plaintext</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Encrypts a string using AES-256 symmetric encryption in CBC mode</span>
<span class="sd">        and adds an HMAC for message authentication.</span>

<span class="sd">        The function performs AES-256 encryption on the input string</span>
<span class="sd">        with a given key, then computes an HMAC signature of the</span>
<span class="sd">        encrypted data for verification. This approach provides both</span>
<span class="sd">        confidentiality and integrity/authentication of the message.</span>

<span class="sd">        :param plaintext: The plaintext string to be encrypted.</span>
<span class="sd">        :param key: The secret key used for encryption.</span>
<span class="sd">               Must be a 32-byte key for AES-256.</span>
<span class="sd">        :return: The encrypted string, encoded with Base64 to ensure the</span>
<span class="sd">                 encrypted data is text-safe. With padding removed for</span>
<span class="sd">                 storage efficiency.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Ensure the AES key length is valid for AES-256</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">32</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;AES key must be 32 bytes long for AES-256.&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Generate a random salt used to randomizes the KDFs output</span>
        <span class="c1"># Used to derive 2 keys, one for encryption and one for signing</span>
        <span class="n">salt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_key</span><span class="p">(</span><span class="n">KeyType</span><span class="o">.</span><span class="n">AES256</span><span class="p">,</span> <span class="n">KeyOutputType</span><span class="o">.</span><span class="n">BYTES</span><span class="p">)</span>
        <span class="c1"># Encode the salt to url-safe byte array</span>
        <span class="n">salt_base64</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64encode</span><span class="p">(</span><span class="n">salt</span><span class="p">)</span>

        <span class="c1"># Derive keys from master key</span>
        <span class="n">aes_key</span><span class="p">,</span> <span class="n">hash_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_derive_key_hkdf</span><span class="p">(</span><span class="n">salt</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>

        <span class="c1"># Generate a random 16-byte IV (Initialization Vector)</span>
        <span class="n">iv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_key</span><span class="p">(</span><span class="n">KeyType</span><span class="o">.</span><span class="n">INITIALIZATION_VECTOR</span><span class="p">,</span> <span class="n">KeyOutputType</span><span class="o">.</span><span class="n">BYTES</span><span class="p">)</span>

        <span class="n">b_plaintext</span> <span class="o">=</span> <span class="n">plaintext</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>

        <span class="c1"># Pad the input string to ensure it&#39;s a multiple of block size</span>
        <span class="n">padder</span> <span class="o">=</span> <span class="n">cryptography</span><span class="o">.</span><span class="n">hazmat</span><span class="o">.</span><span class="n">primitives</span><span class="o">.</span><span class="n">padding</span><span class="o">.</span><span class="n">PKCS7</span><span class="p">(</span>
            <span class="n">cryptography</span><span class="o">.</span><span class="n">hazmat</span><span class="o">.</span><span class="n">primitives</span><span class="o">.</span><span class="n">ciphers</span><span class="o">.</span><span class="n">algorithms</span><span class="o">.</span><span class="n">AES</span><span class="o">.</span><span class="n">block_size</span>
        <span class="p">)</span><span class="o">.</span><span class="n">padder</span><span class="p">()</span>
        <span class="n">b_plaintext_padded</span> <span class="o">=</span> <span class="n">padder</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">b_plaintext</span><span class="p">)</span> <span class="o">+</span> <span class="n">padder</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>

        <span class="c1"># Create a Cipher object for AES-256 in CBC mode</span>
        <span class="n">cipher</span> <span class="o">=</span> <span class="n">cryptography</span><span class="o">.</span><span class="n">hazmat</span><span class="o">.</span><span class="n">primitives</span><span class="o">.</span><span class="n">ciphers</span><span class="o">.</span><span class="n">Cipher</span><span class="p">(</span>
            <span class="n">cryptography</span><span class="o">.</span><span class="n">hazmat</span><span class="o">.</span><span class="n">primitives</span><span class="o">.</span><span class="n">ciphers</span><span class="o">.</span><span class="n">algorithms</span><span class="o">.</span><span class="n">AES</span><span class="p">(</span><span class="n">aes_key</span><span class="p">),</span>
            <span class="n">cryptography</span><span class="o">.</span><span class="n">hazmat</span><span class="o">.</span><span class="n">primitives</span><span class="o">.</span><span class="n">ciphers</span><span class="o">.</span><span class="n">modes</span><span class="o">.</span><span class="n">CBC</span><span class="p">(</span><span class="n">iv</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Encrypt the padded data</span>
        <span class="n">encryptor</span> <span class="o">=</span> <span class="n">cipher</span><span class="o">.</span><span class="n">encryptor</span><span class="p">()</span>
        <span class="n">b_ciphertext</span> <span class="o">=</span> <span class="n">encryptor</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">b_plaintext_padded</span><span class="p">)</span> <span class="o">+</span> <span class="n">encryptor</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>

        <span class="c1"># The IV needs to be stored with the ciphertext for decryption</span>
        <span class="n">b_ciphertext_iv</span> <span class="o">=</span> <span class="n">iv</span> <span class="o">+</span> <span class="n">b_ciphertext</span>

        <span class="c1"># Sign the encrypted data with IV</span>
        <span class="n">b_ciphertext_signed_base64</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">b_ciphertext_iv</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">)</span>

        <span class="c1"># Add the salt used to derive the 2 keys to the data so that the</span>
        <span class="c1"># decrypt function can derive the same keys again</span>
        <span class="n">b_ciphertext_signed_salt</span> <span class="o">=</span> <span class="n">b_ciphertext_signed_base64</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&quot;&amp;&quot;</span> <span class="o">+</span> <span class="n">salt_base64</span>

        <span class="c1"># Encode base64 to remove the &amp;</span>
        <span class="n">b_ciphertext_signed_salt_base64</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64encode</span><span class="p">(</span><span class="n">b_ciphertext_signed_salt</span><span class="p">)</span>

        <span class="c1"># Decode Base64 and strip the &quot;=&quot; padding at the end if not a</span>
        <span class="c1"># multiple of 4</span>
        <span class="n">ciphertext</span> <span class="o">=</span> <span class="n">b_ciphertext_signed_salt_base64</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ciphertext</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_decrypt_aes256</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ciphertext</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Decrypts a string that was encrypted using AES-256 symmetric</span>
<span class="sd">        encryption in CBC mode and verifies its HMAC signature.</span>

<span class="sd">        This function attempts to decrypt a provided string using a</span>
<span class="sd">        specified AES key. Before decryption, it verifies the HMAC to</span>
<span class="sd">        ensure the message&#39;s integrity and authenticity.</span>
<span class="sd">        If the HMAC verification fails, the function logs a warning and</span>
<span class="sd">        returns an empty string, indicating a potential tampering or</span>
<span class="sd">        authenticity issue.</span>

<span class="sd">        :param ciphertext: The encrypted string to be decrypted.</span>
<span class="sd">               Padding will be re-added internally for decryption.</span>
<span class="sd">        :param key: The secret key used for encryption.</span>
<span class="sd">               Must be a 32-byte key for AES-256.</span>
<span class="sd">        :return: The decrypted plaintext string. Returns an empty string</span>
<span class="sd">                 and logs a warning if decryption fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Ensure the AES key length is valid for AES-256</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">32</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;AES key must be 32 bytes long for AES-256.&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Correct the Base64 padding if necessary</span>
        <span class="n">missing_padding</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ciphertext</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span>
        <span class="k">if</span> <span class="n">missing_padding</span><span class="p">:</span>
            <span class="n">ciphertext</span> <span class="o">+=</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">4</span> <span class="o">-</span> <span class="n">missing_padding</span><span class="p">)</span>

        <span class="n">b_ciphertext_signed_salt_base64</span> <span class="o">=</span> <span class="n">ciphertext</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>

        <span class="c1"># Decode base64 to reveal the &amp;</span>
        <span class="n">b_ciphertext_signed_salt</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64decode</span><span class="p">(</span><span class="n">b_ciphertext_signed_salt_base64</span><span class="p">)</span>

        <span class="c1"># Split the data and salt at the &amp;</span>
        <span class="n">b_ciphertext_signed_base64</span><span class="p">,</span> <span class="n">salt_base64</span> <span class="o">=</span> <span class="n">b_ciphertext_signed_salt</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;&amp;&quot;</span><span class="p">)</span>

        <span class="c1"># Decode the salt to bytes</span>
        <span class="n">salt</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64decode</span><span class="p">(</span><span class="n">salt_base64</span><span class="p">)</span>

        <span class="c1"># Derive keys from master key</span>
        <span class="n">aes_key</span><span class="p">,</span> <span class="n">hash_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_derive_key_hkdf</span><span class="p">(</span><span class="n">salt</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>

        <span class="c1"># Verify signature</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">verify_signature</span><span class="p">(</span><span class="n">b_ciphertext_signed_base64</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;signature_valid&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># If verification is successful get the data</span>
        <span class="n">b_ciphertext_iv</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">b_ciphertext_iv</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)</span>

        <span class="c1"># Extract the IV (Initialization Vector) and the encrypted</span>
        <span class="c1"># string</span>
        <span class="n">iv</span> <span class="o">=</span> <span class="n">b_ciphertext_iv</span><span class="p">[:</span><span class="mi">16</span><span class="p">]</span>
        <span class="n">b_ciphertext</span> <span class="o">=</span> <span class="n">b_ciphertext_iv</span><span class="p">[</span><span class="mi">16</span><span class="p">:]</span>

        <span class="c1"># Create a Cipher object for AES-256 in CBC mode</span>
        <span class="n">cipher</span> <span class="o">=</span> <span class="n">cryptography</span><span class="o">.</span><span class="n">hazmat</span><span class="o">.</span><span class="n">primitives</span><span class="o">.</span><span class="n">ciphers</span><span class="o">.</span><span class="n">Cipher</span><span class="p">(</span>
            <span class="n">cryptography</span><span class="o">.</span><span class="n">hazmat</span><span class="o">.</span><span class="n">primitives</span><span class="o">.</span><span class="n">ciphers</span><span class="o">.</span><span class="n">algorithms</span><span class="o">.</span><span class="n">AES</span><span class="p">(</span><span class="n">aes_key</span><span class="p">),</span>
            <span class="n">cryptography</span><span class="o">.</span><span class="n">hazmat</span><span class="o">.</span><span class="n">primitives</span><span class="o">.</span><span class="n">ciphers</span><span class="o">.</span><span class="n">modes</span><span class="o">.</span><span class="n">CBC</span><span class="p">(</span><span class="n">iv</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Decrypt the data</span>
        <span class="n">decryptor</span> <span class="o">=</span> <span class="n">cipher</span><span class="o">.</span><span class="n">decryptor</span><span class="p">()</span>
        <span class="n">b_plaintext_padded</span> <span class="o">=</span> <span class="n">decryptor</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">b_ciphertext</span><span class="p">)</span> <span class="o">+</span> <span class="n">decryptor</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>

        <span class="c1"># Remove padding</span>
        <span class="n">unpadder</span> <span class="o">=</span> <span class="n">cryptography</span><span class="o">.</span><span class="n">hazmat</span><span class="o">.</span><span class="n">primitives</span><span class="o">.</span><span class="n">padding</span><span class="o">.</span><span class="n">PKCS7</span><span class="p">(</span>
            <span class="n">cryptography</span><span class="o">.</span><span class="n">hazmat</span><span class="o">.</span><span class="n">primitives</span><span class="o">.</span><span class="n">ciphers</span><span class="o">.</span><span class="n">algorithms</span><span class="o">.</span><span class="n">AES</span><span class="o">.</span><span class="n">block_size</span>
        <span class="p">)</span><span class="o">.</span><span class="n">unpadder</span><span class="p">()</span>
        <span class="n">b_plaintext</span> <span class="o">=</span> <span class="n">unpadder</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">b_plaintext_padded</span><span class="p">)</span> <span class="o">+</span> <span class="n">unpadder</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>

        <span class="c1"># Decode</span>
        <span class="n">plaintext</span> <span class="o">=</span> <span class="n">b_plaintext</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">plaintext</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_derive_key_hkdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">salt</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">key_material</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Derives two distinct keys (an AES encryption key and a hash key)</span>
<span class="sd">        from a given master key.</span>

<span class="sd">        This function uses the HMAC-based Key Derivation Function (HKDF)</span>
<span class="sd">        with SHA-256 hash algorithm to derive two separate 32-byte keys</span>
<span class="sd">        from the provided master key. A 16-bytes salt is use in the</span>
<span class="sd">        HKDF, ensuring the uniqueness of the derived keys even when the</span>
<span class="sd">        same master key is used.</span>
<span class="sd">        The &#39;info&#39; parameter is utilized to differentiate the purpose of</span>
<span class="sd">        each derived key.</span>

<span class="sd">        :param salt: A byte string used to salt the key derivation to</span>
<span class="sd">               prevent rainbow table attacks. The salt should be unique</span>
<span class="sd">               for each credential to be protected but does not need to</span>
<span class="sd">               be kept secret.</span>
<span class="sd">        :param key_material: The master key from which the AES and hash</span>
<span class="sd">               keys are derived.</span>
<span class="sd">        :return: A tuple containing two bytes objects:</span>
<span class="sd">                 the AES key and the hash key.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Derive the AES encryption key</span>
        <span class="n">aes_key_hkdf</span> <span class="o">=</span> <span class="n">cryptography</span><span class="o">.</span><span class="n">hazmat</span><span class="o">.</span><span class="n">primitives</span><span class="o">.</span><span class="n">kdf</span><span class="o">.</span><span class="n">hkdf</span><span class="o">.</span><span class="n">HKDF</span><span class="p">(</span>
            <span class="n">algorithm</span><span class="o">=</span><span class="n">cryptography</span><span class="o">.</span><span class="n">hazmat</span><span class="o">.</span><span class="n">primitives</span><span class="o">.</span><span class="n">hashes</span><span class="o">.</span><span class="n">SHA256</span><span class="p">(),</span>
            <span class="n">length</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
            <span class="n">salt</span><span class="o">=</span><span class="n">salt</span><span class="p">,</span>
            <span class="n">info</span><span class="o">=</span><span class="sa">b</span><span class="s2">&quot;aes-key&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">aes_key</span> <span class="o">=</span> <span class="n">aes_key_hkdf</span><span class="o">.</span><span class="n">derive</span><span class="p">(</span><span class="n">key_material</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;AES key derived successfully&quot;</span><span class="p">)</span>

        <span class="c1"># Derive the hash key</span>
        <span class="n">hash_key_hkdf</span> <span class="o">=</span> <span class="n">cryptography</span><span class="o">.</span><span class="n">hazmat</span><span class="o">.</span><span class="n">primitives</span><span class="o">.</span><span class="n">kdf</span><span class="o">.</span><span class="n">hkdf</span><span class="o">.</span><span class="n">HKDF</span><span class="p">(</span>
            <span class="n">algorithm</span><span class="o">=</span><span class="n">cryptography</span><span class="o">.</span><span class="n">hazmat</span><span class="o">.</span><span class="n">primitives</span><span class="o">.</span><span class="n">hashes</span><span class="o">.</span><span class="n">SHA256</span><span class="p">(),</span>
            <span class="n">length</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
            <span class="n">salt</span><span class="o">=</span><span class="n">salt</span><span class="p">,</span>
            <span class="n">info</span><span class="o">=</span><span class="sa">b</span><span class="s2">&quot;hash-key&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">hash_key</span> <span class="o">=</span> <span class="n">hash_key_hkdf</span><span class="o">.</span><span class="n">derive</span><span class="p">(</span><span class="n">key_material</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Hashing key derived successfully&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">aes_key</span><span class="p">,</span> <span class="n">hash_key</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_derive_key_scrypt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">salt</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">key_material</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Derives a cryptographic key from a given key material using the</span>
<span class="sd">        Scrypt KDF.</span>

<span class="sd">        Scrypt is designed to be resistant against hardware-assisted</span>
<span class="sd">        attacks by allowing tunable memory and CPU cost parameters.</span>
<span class="sd">        It is particularly suitable for password storage and protection.</span>

<span class="sd">        :param salt: A byte string used to salt the key derivation to</span>
<span class="sd">               prevent rainbow table attacks. The salt should be unique</span>
<span class="sd">               for each credential to be protected but does not need to</span>
<span class="sd">               be kept secret.</span>
<span class="sd">        :param key_material: The input key material from which to derive</span>
<span class="sd">               the key.</span>
<span class="sd">        :return: The derived cryptographic key.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Scrypt configuration</span>
        <span class="n">length</span> <span class="o">=</span> <span class="mi">32</span>  <span class="c1"># The desired length of the derived key in bytes</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">14</span>  <span class="c1"># CPU/Memory cost parameter. It must be larger than 1 and be a power of 2</span>
        <span class="n">r</span> <span class="o">=</span> <span class="mi">8</span>  <span class="c1"># Block size parameter</span>
        <span class="n">p</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Parallelization parameter</span>

        <span class="n">scrypt</span> <span class="o">=</span> <span class="n">cryptography</span><span class="o">.</span><span class="n">hazmat</span><span class="o">.</span><span class="n">primitives</span><span class="o">.</span><span class="n">kdf</span><span class="o">.</span><span class="n">scrypt</span><span class="o">.</span><span class="n">Scrypt</span><span class="p">(</span>
            <span class="n">salt</span><span class="o">=</span><span class="n">salt</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">length</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">r</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">p</span>
        <span class="p">)</span>

        <span class="c1"># Derive the key</span>
        <span class="n">key_derived</span> <span class="o">=</span> <span class="n">scrypt</span><span class="o">.</span><span class="n">derive</span><span class="p">(</span><span class="n">key_material</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Scrypt key derived successfully&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">key_derived</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_verify_derived_key_scrypt</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">salt</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">key_material</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">expected_key</span><span class="p">:</span> <span class="nb">bytes</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verifies a derived key against an expected key using the Scrypt</span>
<span class="sd">        KDF.</span>

<span class="sd">        :param salt: A byte string used to salt the key derivation to</span>
<span class="sd">               prevent rainbow table attacks. The salt should be unique</span>
<span class="sd">               for each credential to be protected but does not need to</span>
<span class="sd">               be kept secret.</span>
<span class="sd">        :param key_material: The original key material used for key</span>
<span class="sd">               derivation.</span>
<span class="sd">        :param expected_key: The expected derived key to verify against.</span>
<span class="sd">        :raise: Exception is raised when the derived key does not match</span>
<span class="sd">                the expected key.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Re-configure Scrypt with the same parameters used for deriving</span>
        <span class="c1"># the key</span>
        <span class="n">length</span> <span class="o">=</span> <span class="mi">32</span>  <span class="c1"># The desired length of the derived key in bytes</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">14</span>  <span class="c1"># CPU/Memory cost parameter. It must be larger than 1 and be a power of 2</span>
        <span class="n">r</span> <span class="o">=</span> <span class="mi">8</span>  <span class="c1"># Block size parameter</span>
        <span class="n">p</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Parallelization parameter</span>

        <span class="n">scrypt</span> <span class="o">=</span> <span class="n">cryptography</span><span class="o">.</span><span class="n">hazmat</span><span class="o">.</span><span class="n">primitives</span><span class="o">.</span><span class="n">kdf</span><span class="o">.</span><span class="n">scrypt</span><span class="o">.</span><span class="n">Scrypt</span><span class="p">(</span>
            <span class="n">salt</span><span class="o">=</span><span class="n">salt</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">length</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">r</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">p</span>
        <span class="p">)</span>

        <span class="c1"># Attempt to verify the derived key</span>
        <span class="n">scrypt</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">key_material</span><span class="p">,</span> <span class="n">expected_key</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Scrypt key verified successfully&quot;</span><span class="p">)</span></div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">CarlogttPythonLibrary</a></h1>










<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../_apidoc/modules.html">src</a></li>
</ul>


<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>










        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2025, Carlo Gatti.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>
